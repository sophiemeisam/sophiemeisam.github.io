<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ngũ Linh Dịch — Lập quẻ (1 file)</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto; padding: 18px; background: #fafafa; color: #111; }
  h1 { margin: 0 0 8px; }
  .panel { background: #fff; border: 1px solid #e6e6e6; padding: 12px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
  label { display: block; margin: 8px 0 4px; font-weight: 600; }
  input[type="date"], select, button { padding: 8px; border-radius: 6px; border: 1px solid #ddd; }
  .hours { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-top: 12px; }
  .hourCard { padding: 12px; border-radius: 8px; border: 1px solid #eee; background: #fff; cursor: pointer; transition: box-shadow 0.3s ease; }
  .hourCard:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .hex { display: flex; flex-direction: column; align-items: center; margin: 8px 0; }
  .line { width: 80%; height: 12px; margin: 4px 0; display: flex; justify-content: center; align-items: center; }
  .yang .bar { width: 100%; height: 6px; background: #000; border-radius: 2px; }
  .yin { justify-content: space-between; }
  .yin .bar { width: 40%; height: 6px; background: #000; border-radius: 2px; }
  .dong .bar { background: #f00 !important; }
  .small { font-size: 13px; color: #555; }
  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .note { font-size: 13px; color: #444; margin-top: 10px; }
  .config { margin-top: 12px; font-size: 13px; }
  pre { background: #0f172a; color: #e6eef8; padding: 12px; border-radius: 6px; overflow: auto; }
  .element-thuy { color: blue; }
  .element-tho { color: brown; }
  .element-moc { color: green; }
  .element-hoa { color: red; }
  .element-kim { color: goldenrod; }
  .star-main { font-weight: bold; color: #d00; }
  button { background: #007bff; color: white; border: none; cursor: pointer; transition: background 0.3s; }
  button:hover { background: #0056b3; }
</style>
</head>
<body>

<h1>Ngũ Linh Dịch — máy tính (một file)</h1>
<div class="panel">
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <div>
      <label>Chọn ngày (dùng để xác lập Nguyệt-kiến, Can ngày...)</label>
      <input id="dateInput" type="date" value="">
    </div>
    <div>
      <label>Chọn giờ tham chiếu (nếu muốn xem quẻ giờ cụ thể)</label>
      <select id="hourSelect">
        <option value="0">Tý (23:00-01:00)</option>
        <option value="1">Sửu (01:00-03:00)</option>
        <option value="2">Dần (03:00-05:00)</option>
        <option value="3">Mão (05:00-07:00)</option>
        <option value="4">Thìn (07:00-09:00)</option>
        <option value="5">Tỵ (09:00-11:00)</option>
        <option value="6">Ngọ (11:00-13:00)</option>
        <option value="7">Mùi (13:00-15:00)</option>
        <option value="8">Thân (15:00-17:00)</option>
        <option value="9">Dậu (17:00-19:00)</option>
        <option value="10">Tuất (19:00-21:00)</option>
        <option value="11">Hợi (21:00-23:00)</option>
      </select>
    </div>
    <div style="align-self:end">
      <label style="visibility:hidden">btn</label>
      <button id="makeBtn">Tạo 12 quẻ cho ngày</button>
    </div>
  </div>
  <div class="note">
    <strong>Giải thích nhanh:</strong>
    Mã thực hiện theo quy tắc lập quẻ Ngũ Linh Dịch: Nguyệt-kiến → tiến ngày → dừng làm "Tý" → tiến tới giờ lấy quẻ để xác định cung Chủ → lấy Tiên thiên/Hậu thiên → nạp sao Thiên bồng (dựa trên Hành từ nạp âm giờ) → tính hào Nguyên & hào Động → quẻ Chánh/Hỗ/Biến.
  </div>
</div>

<div id="result" style="margin-top:14px"></div>

<hr style="margin:20px 0">

<div class="panel">
  <h3>Cấu hình (nếu muốn tinh chỉnh)</h3>
  <div class="config">
    <div class="small">- Mảng <code>trigramSequence</code> = thứ tự Tiên thiên bát quái dùng để đặt vào 12 cung (có thể chỉnh).<br/>
    - Mảng <code>stars</code> = thứ tự và hành của 10 sao Thiên bồng (không đổi trừ khi bạn có quy ước khác).<br/>
    - Nếu cần chỉnh thứ tự quẻ hoặc sao, mở file HTML và sửa mảng tương ứng.</div>
  </div>
</div>

<script>
/* ***************** QUY ƯỚC VÀ BẢNG DỮ LIỆU ***************** */

// 12 Địa chi
const branches = ['Tý','Sửu','Dần','Mão','Thìn','Tỵ','Ngọ','Mùi','Thân','Dậu','Tuất','Hợi'];

// Nguyệt kiến
const nguyetKien = {
  1:'Dần',2:'Mão',3:'Thìn',4:'Tỵ',5:'Ngọ',6:'Mùi',
  7:'Thân',8:'Dậu',9:'Tuất',10:'Hợi',11:'Tý',12:'Sửu'
};

// Tiên thiên bát quái thứ tự
let trigramSequence = ['Càn','Đoài','Ly','Chấn','Tốn','Khảm','Cấn','Khôn'];

// Mã nhị phân quái (trái -> phải ứng với trên -> dưới, tức hào 3, 2, 1)
const trigramBits = {
  'Càn': [1,1,1],   // 111
  'Đoài': [0,1,1],  // 011
  'Ly': [1,0,1],    // 101
  'Chấn': [0,0,1],  // 001
  'Tốn': [1,1,0],   // 110
  'Khảm': [0,1,0],  // 010
  'Cấn': [1,0,0],   // 100
  'Khôn': [0,0,0]   // 000
};

// Thập thiên tinh
const stars = [
  {id:1, name:'Thiên bồng', element:'Thủy', sign:'+'},
  {id:2, name:'Thiên nhuế', element:'Thổ', sign:'-'},
  {id:3, name:'Thiên xung', element:'Mộc', sign:'+'},
  {id:4, name:'Thiên phụ', element:'Mộc', sign:'-'},
  {id:5, name:'Thiên cầm', element:'Hỏa', sign:'+'},
  {id:6, name:'Thiên tâm', element:'Kim', sign:'+'},
  {id:7, name:'Thiên trụ', element:'Kim', sign:'-'},
  {id:8, name:'Thiên nhậm', element:'Thổ', sign:'+'},
  {id:9, name:'Thiên anh', element:'Hỏa', sign:'-'},
  {id:10,name:'Thiên không', element:'Thủy', sign:'-'}
];

// Can
const stems = ['Giáp','Ất','Bính','Đinh','Mậu','Kỷ','Canh','Tân','Nhâm','Quý'];
const stemElement = { 'Giáp':'Mộc','Ất':'Mộc','Bính':'Hỏa','Đinh':'Hỏa','Mậu':'Thổ','Kỷ':'Thổ','Canh':'Kim','Tân':'Kim','Nhâm':'Thủy','Quý':'Thủy' };
function isYangStem(name){ return stems.indexOf(name) % 2 === 0; }

// Bảng Ngũ hành từ nạp âm cho 60 Giáp Tý
const napYinElements = [
  null,
  'Kim', 'Kim', 'Hỏa', 'Hỏa', 'Mộc', 'Mộc', 'Thổ', 'Thổ', 'Kim', 'Kim',
  'Hỏa', 'Hỏa', 'Thủy', 'Thủy', 'Thổ', 'Thổ', 'Kim', 'Kim', 'Mộc', 'Mộc',
  'Thủy', 'Thủy', 'Thổ', 'Thổ', 'Hỏa', 'Hỏa', 'Mộc', 'Mộc', 'Thủy', 'Thủy',
  'Kim', 'Kim', 'Hỏa', 'Hỏa', 'Mộc', 'Mộc', 'Thổ', 'Thổ', 'Kim', 'Kim',
  'Hỏa', 'Hỏa', 'Thủy', 'Thủy', 'Thổ', 'Thổ', 'Kim', 'Kim', 'Mộc', 'Mộc',
  'Thủy', 'Thủy', 'Thổ', 'Thổ', 'Hỏa', 'Hỏa', 'Mộc', 'Mộc', 'Thủy', 'Thủy'
];

// Lấy số cycle cho Can Chi
function getCycleNumber(stemIdx, branchIdx) {
  for(let n=1; n<=60; n++){
    if((n-1) % 10 === stemIdx && (n-1) % 12 === branchIdx) return n;
  }
  return -1;
}

// Lấy Hành từ nạp âm
function getHourElement(stemName, branchName) {
  const stemIdx = stems.indexOf(stemName);
  const branchIdx = branches.indexOf(branchName);
  const cycle = getCycleNumber(stemIdx, branchIdx);
  return napYinElements[cycle] || 'Thủy';
}

function trigramIndex(name){
  const i = trigramSequence.indexOf(name);
  return i>=0 ? i+1 : null;
}

function idxBranch(name){ return branches.indexOf(name); }

function jdnOfGregorian(year, month, day){
  let a = Math.floor((14 - month)/12);
  let y = year + 4800 - a;
  let m = month + 12*a - 3;
  let jdn = day + Math.floor((153*m + 2)/5) + 365*y + Math.floor(y/4) - Math.floor(y/100) + Math.floor(y/400) - 32045;
  return jdn;
}

function dayStemBranchFromDate(year,month,day){
  const JD = jdnOfGregorian(year,month,day);
  const tIdx = ((JD - 1) % 10 + 10) % 10;
  const bIdx = ((JD + 1) % 12 + 12) % 12;
  return { stem: stems[tIdx], branch: branches[bIdx], JD };
}

function tyStemStartFromDayStem(dayStem){
  if(['Giáp','Kỷ'].includes(dayStem)) return 'Giáp';
  if(['Ất','Canh'].includes(dayStem)) return 'Bính';
  if(['Bính','Tân'].includes(dayStem)) return 'Mậu';
  if(['Đinh','Nhâm'].includes(dayStem)) return 'Canh';
  if(['Mậu','Quý'].includes(dayStem)) return 'Nhâm';
  return 'Giáp';
}

function hourStemFromTyStart(tyStart, hourIndex){
  const startIndex = stems.indexOf(tyStart);
  const idx = (startIndex + hourIndex) % 10;
  return stems[idx];
}

function startPosCangForYear(year){
  const yearBranchIdx = ((year - 4) % 12 + 12) % 12;
  const yearBranch = branches[yearBranchIdx];
  if(['Dần','Ngọ','Tuất'].includes(yearBranch)) return idxBranch('Ngọ');
  if(['Thân','Tý','Thìn'].includes(yearBranch)) return idxBranch('Tý');
  if(['Tỵ','Dậu','Sửu'].includes(yearBranch)) return idxBranch('Dậu');
  if(['Hợi','Mão','Mùi'].includes(yearBranch)) return idxBranch('Mão');
  return 0;
}

function buildTrigramAt12(startPos){
  const res = new Array(12);
  for(let i=0;i<12;i++){
    const qIdx = ((i - startPos) % 8 + 8) % 8;
    res[i] = trigramSequence[qIdx];
  }
  return res;
}

function buildStarsAt12(startStarIndex){
  const arr = new Array(12);
  for(let i=0;i<12;i++){
    arr[i] = stars[(startStarIndex + i) % 10];
  }
  return arr;
}

function computeNguyenDuong(hauIndex, starId){
  const s = hauIndex + starId;
  if(s <= 6) return s;
  const r = s % 6;
  return r === 0 ? 6 : r;
}

function makeHexFromTrigrams(bottomTrig, topTrig){
  const bot = trigramBits[bottomTrig]; // [hào 3, hào 2, hào 1]
  const top = trigramBits[topTrig];    // [hào 3, hào 2, hào 1]
  // Ghép thành quẻ kép: bot (hào 1,2,3) + top (hào 4,5,6)
  return bot.concat(top); // [hào 1,2,3,4,5,6] bottom -> top
}

function renderHexLines(bits, haoDong = 0){
  let html = '';
  for(let displayIdx = 0; displayIdx < 6; displayIdx++){
    const bitIdx = 5 - displayIdx; // Hiển thị từ trên xuống (hào 6 -> hào 1)
    const lineNo = bitIdx + 1; // Hào 1 bottom, 6 top
    const isYang = bits[bitIdx] === 1;
    const isDong = (haoDong > 0 && lineNo === haoDong);
    const className = `line ${isYang ? 'yang' : 'yin'} ${isDong ? 'dong' : ''}`;
    html += `<div class="${className}">`;
    if(isYang){
      html += `<div class="bar"></div>`;
    } else {
      html += `<div class="bar half"></div><div class="bar half"></div>`;
    }
    html += `</div>`;
  }
  return html;
}

function flipLine(bits, lineNo){
  const b = bits.slice();
  const idx = lineNo - 1;
  b[idx] = b[idx] === 1 ? 0 : 1;
  return b;
}

function makeHo(hexBits){
  const h2 = hexBits[1], h3 = hexBits[2], h4 = hexBits[3], h5 = hexBits[4];
  const lower = [h2, h3, h4];
  const upper = [h3, h4, h5];
  return lower.concat(upper);
}

function napGiapForLines(hourStem){
  const start = stems.indexOf(hourStem);
  const res = [];
  for(let i=0;i<6;i++){
    res.push(stems[(start + i) % 10]);
  }
  return res;
}

function basicThapThan(dayStem, lineStem){
  const dayEl = stemElement[dayStem];
  const lineEl = stemElement[lineStem];
  if(dayEl === lineEl){
    return isYangStem(lineStem) ? 'Chính Ấn (đồng hành dương)' : 'Thiếu Ấn (đồng hành âm)';
  }
  const order = ['Thổ','Kim','Thủy','Mộc','Hỏa'];
  const idxDay = order.indexOf(dayEl), idxLine = order.indexOf(lineEl);
  if(idxDay>=0 && idxLine>=0){
    if((idxDay + 1) %5 === idxLine) return 'Thiên Tài (được sinh)';
    if((idxLine + 1) %5 === idxDay) return 'Tỷ Thân (khắc/chi phối)';
  }
  return 'Khác';
}

const dateInput = document.getElementById('dateInput');
const makeBtn = document.getElementById('makeBtn');
const resultDiv = document.getElementById('result');
const hourSelect = document.getElementById('hourSelect');

const today = new Date();
dateInput.valueAsDate = today;

makeBtn.addEventListener('click', ()=> {
  const dt = dateInput.value;
  if(!dt){ alert('Chọn ngày trước'); return; }
  const d = new Date(dt + 'T00:00:00');
  const year = d.getFullYear(), month = d.getMonth()+1, day = d.getDate();
  renderAllHoursForDate(year,month,day);
});

function renderAllHoursForDate(year,month,day){
  resultDiv.innerHTML = '';
  const daySB = dayStemBranchFromDate(year,month,day);
  const dayStem = daySB.stem, dayBranch = daySB.branch;
  const JD = daySB.JD;
  const monthForNguyet = month;
  const nguyetChi = nguyetKien[monthForNguyet];
  const nguyetIdx = idxBranch(nguyetChi);
  const startCang = startPosCangForYear(year);
  const trigramAt12 = buildTrigramAt12(startCang);

  const header = document.createElement('div');
  header.className = 'panel';
  header.innerHTML = `<div><strong>Ngày lấy quẻ:</strong> ${day}/${month}/${year} — Can ngày: <strong>${dayStem}</strong>, Chi ngày: <strong>${dayBranch}</strong> (JDN=${JD})</div>
                      <div class="small">Nguyệt-kiến tháng ${month} → <strong>${nguyetChi}</strong></div>
                      <div class="small">Bố trí Tiên thiên bát quái (vị trí Càn khởi tại ${branches[startCang]})</div>`;
  resultDiv.appendChild(header);

  const container = document.createElement('div');
  container.className = 'hours';
  resultDiv.appendChild(container);

  for(let h=0; h<12; h++){
    const card = document.createElement('div');
    card.className = 'hourCard panel';
    const posIdx = (nguyetIdx + (day-1) + h) % 12;
    const hauTrig = trigramAt12[posIdx];
    const hauIndex = trigramIndex(hauTrig);
    const tyStart = tyStemStartFromDayStem(dayStem);
    const hourStem = hourStemFromTyStart(tyStart, h);
    const hourBranch = branches[h];
    const hourElement = getHourElement(hourStem, hourBranch);
    const hourPolarity = isYangStem(hourStem) ? '+' : '-';
    let startStarIdx = stars.findIndex(s => s.element === hourElement && s.sign === hourPolarity);
    if(startStarIdx === -1){
      startStarIdx = stars.findIndex(s => s.element === hourElement);
      if(startStarIdx === -1) startStarIdx = 0;
    }
    const starsAt12 = buildStarsAt12(startStarIdx);
    const starAtPos = starsAt12[posIdx];
    let tienIndex = starAtPos.id > 8 ? starAtPos.id - 8 : starAtPos.id;
    const tienTrig = trigramSequence[tienIndex - 1];
    const nguyen = computeNguyenDuong(hauIndex, starAtPos.id);
    const haoDong = ((nguyen - 1) + h) % 6 + 1;
    const dayIsYang = isYangStem(dayStem);
    let bottomTrig, topTrig;
    if(dayIsYang){
      bottomTrig = hauTrig;
      topTrig = tienTrig;
    } else {
      bottomTrig = tienTrig;
      topTrig = hauTrig;
    }
    const chanhBits = makeHexFromTrigrams(bottomTrig, topTrig);
    const bienBits = flipLine(chanhBits, haoDong);
    const hoBits = makeHo(chanhBits);
    const napGiap = napGiapForLines(hourStem);
    const thapThan = napGiap.map(s=> basicThapThan(dayStem,s));

    card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>Giờ ${branches[h]}</strong>
          <div class="small">Can giờ: <strong>${hourStem}${branches[h]}</strong> — Hành (nạp âm): <span class="element-${hourElement.toLowerCase()}"><strong>${hourElement} ${hourPolarity}</strong></span></div>
        </div>
        <div class="small" style="text-align:right">Hậu: <strong>${hauTrig}</strong> | Tiên: <strong>${tienTrig}</strong><br/>
          Sao chủ tinh: <span class="star-main">${starAtPos.name} (#${starAtPos.id})</span>
        </div>
      </div>
      <hr/>
      <div class="small">Nguyên đường: <strong>${nguyen}</strong> — Hào động: <strong>${haoDong}</strong></div>
      <div style="margin-top:8px">
        <div class="small">Quẻ Chánh (bottom→top): <strong>${bottomTrig}</strong> / <strong>${topTrig}</strong></div>
        <div class="hex">
          ${renderHexLines(chanhBits, haoDong)}
        </div>
      </div>
      <div class="small">Quẻ Hỗ:</div>
      <div class="hex">${renderHexLines(hoBits)}</div>
      <div class="small">Quẻ Biến (đổi hào ${haoDong}):</div>
      <div class="hex">${renderHexLines(bienBits)}</div>
      <div class="small" style="margin-top:6px">Nạp Giáp (hào 1..6 bottom→top): ${napGiap.join(', ')}</div>
      <div class="small">Thập Thần (cơ bản): ${thapThan.join(' | ')}</div>
      <div style="margin-top:6px"><button data-hour="${h}" class="detailBtn">Xem chi tiết</button></div>
    `;

    container.appendChild(card);

    card.querySelector('.detailBtn').addEventListener('click', (ev)=>{
      renderDetailHour({
        year,month,day,h, dayStem, dayBranch, JD,
        nguyetChi, posIdx, hauTrig, hauIndex,
        tyStart, hourStem, hourElement, hourPolarity,
        startStarIdx, starsAt12, starAtPos, tienTrig, tienIndex,
        nguyen, haoDong, chanhBits, bienBits, hoBits, napGiap, thapThan, trigramAt12
      });
    });
  }
}

function renderDetailHour(obj){
  let detailEl = document.getElementById('detailPanel');
  if(detailEl) detailEl.remove();

  detailEl = document.createElement('div');
  detailEl.id = 'detailPanel';
  detailEl.className = 'panel';
  const {
    year,month,day,h, dayStem, dayBranch, JD,
    nguyetChi, posIdx, hauTrig, hauIndex,
    tyStart, hourStem, hourElement, hourPolarity,
    startStarIdx, starsAt12, starAtPos, tienTrig, tienIndex,
    nguyen, haoDong, chanhBits, bienBits, hoBits, napGiap, thapThan, trigramAt12
  } = obj;

  const posBranch = branches[posIdx];
  const trigAt12 = trigramAt12.map((q,i)=> `${branches[i]}:${q}`).join(', ');

  detailEl.innerHTML = `<h3>Chi tiết: giờ ${branches[h]} — ${day}/${month}/${year}</h3>
    <div class="small">Can ngày: <strong>${dayStem}</strong> — Chi ngày: <strong>${dayBranch}</strong> (JDN=${JD})</div>
    <div class="small">Nguyệt-kiến: <strong>${nguyetChi}</strong> — Cung Chủ thời lệnh: <strong>${posBranch}</strong></div>
    <div class="small" style="margin-top:8px">Hậu thiên tại cung ${posBranch}: <strong>${hauTrig}</strong> (index ${hauIndex})</div>
    <div class="small">Tiên thiên (ra từ sao): <strong>${tienTrig}</strong> (từ sao <span class="star-main">${starAtPos.name} #${starAtPos.id}</span>)</div>
    <div class="small">Sao tại tất cả 12 cung (bắt đầu tại cung Tý sao #${starsAt12[0].id}):<br/><span class="small">${starsAt12.map((s,i)=> branches[i]+':'+s.name+'(#'+s.id+')').join('; ')}</span></div>
    <div style="margin-top:10px" class="grid2">
      <div>
        <div class="small"><strong>Quẻ Chánh (bottom→top):</strong> ${ (isYangStem(dayStem) ? hauTrig + ' (Hậu dưới)' : tienTrig+' (Hậu trên)') } / ${ (isYangStem(dayStem) ? tienTrig+' (Tiên trên)' : hauTrig+' (Tiên dưới)') }</div>
        <div class="hex">${renderHexLines(chanhBits, haoDong)}</div>
      </div>
      <div>
        <div class="small"><strong>Quẻ Biến:</strong> (đổi hào ${haoDong})</div>
        <div class="hex">${renderHexLines(bienBits)}</div>
      </div>
      <div>
        <div class="small"><strong>Quẻ Hỗ (quy nạp):</strong></div>
        <div class="hex">${renderHexLines(hoBits)}</div>
      </div>
      <div>
        <div class="small"><strong>Nạp Giáp (6 hào bottom→top):</strong></div>
        <div class="small">${napGiap.map((s,i)=> `H${i+1}:${s}`).join(' | ')}</div>
        <div style="margin-top:6px" class="small"><strong>Thập Thần (cơ bản so với Can ngày):</strong><br/>${thapThan.join(' | ')}</div>
      </div>
    </div>
    <div style="margin-top:10px" class="small">
      <strong>Ghi chú kỹ thuật (tóm tắt):</strong>
      <ul>
        <li>Tiên thiên bát quái đặt quanh 12 cung theo tam-hợp năm.</li>
        <li>Hành giờ từ nạp âm Can Chi giờ, sao Thiên bồng đặt tại Tý với sao trùng Hành (và dấu nếu có), thuận quanh vòng.</li>
        <li>Hào Nguyên = tổng số hiệu quẻ Hậu + số hiệu sao, mod6 xử lý theo quy tắc.</li>
        <li>Hào Động = từ Nguyên (Tý) đếm thuận tới giờ.</li>
      </ul>
    </div>
    <div style="margin-top:8px"><button id="closeDetail">Đóng</button></div>
    <hr/>
    <div class="small">Vị trí Tiên thiên trên 12 cung: ${trigAt12}</div>
  `;

  resultDiv.appendChild(detailEl);
  document.getElementById('closeDetail').onclick = ()=> detailEl.remove();
  detailEl.scrollIntoView({behavior:'smooth'});
}

renderAllHoursForDate(today.getFullYear(), today.getMonth()+1, today.getDate());

</script>
</body>
</html>