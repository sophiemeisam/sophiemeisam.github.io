<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gieo Qu·∫ª D·ªãch v·ªõi ƒê·ªìng Xu</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Vietnamese:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif Vietnamese', serif;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #fff3e0, #ffd6cc);
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            max-width: 450px;
            margin: 0 auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .bathuong-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .bathuong {
            width: 131px;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .coin-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .coin {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .coin img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .flip {
            animation: flipAnimation 3s ease-in-out; /* TƒÉng th·ªùi gian l·∫≠t xu l√™n 3s */
        }

        @keyframes flipAnimation {
            0% { transform: rotateY(0deg) translateY(0); }
            50% { transform: rotateY(720deg) translateY(-100px); }
            100% { transform: rotateY(0deg) translateY(0); }
        }

        h2 {
            color: #8b0000;
            font-size: 2rem;
            margin: 20px 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 16px;
            border: 2px solid #8b0000;
            border-radius: 30px;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus {
            border-color: #ff4040;
            box-shadow: 0 0 10px rgba(255, 64, 64, 0.3);
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(45deg, #d32f2f, #b71c1c);
            color: white;
            border: none;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            margin: 5px 0;
            border-radius: 30px;
            transition: background 0.3s, transform 0.2s;
        }

        button:hover {
            background: linear-gradient(45deg, #b71c1c, #9a0007);
            transform: scale(1.05);
        }

        #ket_qua {
            margin-top: 20px;
            text-align: left;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .hao {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hao-dong {
            color: #ff4040;
            font-weight: bold;
        }

        .line-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .yang-line {
            width: 100px;
            height: 10px;
            background: #ff3333;
            border-radius: 3px;
        }

        .yin-line {
            display: flex;
            gap: 10px;
        }

        .yin-line div {
            width: 45px;
            height: 10px;
            background: #333;
            border-radius: 3px;
        }

        .hao-dong .line-container {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .hao-status {
            font-size: 14px;
            margin-left: 10px;
        }

        #ten_que {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #8b0000;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #changed-hexagram {
            margin-top: 20px;
            text-align: left;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #changed-hexagram-name {
            font-size: 18px;
            font-weight: bold;
            color: #8b0000;
            margin-bottom: 10px;
        }

        @media (max-width: 400px) {
            .container {
                max-width: 100%;
            }

            .coin {
                width: 50px;
                height: 50px;
            }

            .yang-line {
                width: 80px;
            }

            .yin-line div {
                width: 35px;
            }

            button {
                width: 100%;
            }

            h2 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- B√°t h∆∞∆°ng ·ªü tr√™n c√πng -->
        <div class="bathuong-container">
            <img src="https://sophiemeisam.github.io/Thien.png" alt="B√°t H∆∞∆°ng" class="bathuong">
        </div>
        <!-- ƒê·ªìng xu ngay d∆∞·ªõi b√°t h∆∞∆°ng -->
        <div class="coin-container">
            <div class="coin" id="coin1"><img src="https://sophiemeisam.github.io/duong.jpg" alt="Coin"></div>
            <div class="coin" id="coin2"><img src="https://sophiemeisam.github.io/duong.jpg" alt="Coin"></div>
            <div class="coin" id="coin3"><img src="https://sophiemeisam.github.io/duong.jpg" alt="Coin"></div>
        </div>
        <!-- √î nh·∫≠p s·ª± vi·ªác, n√∫t Gieo Qu·∫ª, v√† t√™n qu·∫ª -->
        <div>
            <h2>Gieo Qu·∫ª D·ªãch</h2>
            <input type="text" id="su_viec" placeholder="Nh·∫≠p s·ª± vi·ªác c·∫ßn xem">
            <button onclick="gieoQue()">Gieo Qu·∫ª</button>
            <div id="ten_que"></div>
            <!-- N√∫t ch·ª•p qu·∫ª -->
            <button onclick="chupQue()" style="display: none;" id="chup-button">üì∏ Ch·ª•p Qu·∫ª</button>
        </div>
        <!-- K·∫øt qu·∫£ qu·∫ª v√† qu·∫ª bi·∫øn -->
        <div id="ket_qua"></div>
        <div id="changed-hexagram" style="display: none;">
            <div id="changed-hexagram-name"></div>
            <div id="changed-hexagram-lines"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        // Link ·∫£nh cho m·∫∑t h√¨nh v√† m·∫∑t ch·ªØ
        const headsImage = 'https://sophiemeisam.github.io/duong.jpg';
        const tailsImage = 'https://sophiemeisam.github.io/am.jpg';
        const queDon = {
            '111': 'Ki·ªÅn', '011': 'ƒêo√†i', '101': 'Ly', '001': 'Ch·∫•n',
            '110': 'T·ªën', '010': 'Kh·∫£m', '100': 'C·∫•n', '000': 'Kh√¥n'
        };
        const queKep = {
            '111111': 'Thu·∫ßn Ki·ªÅn', '111110': 'Thi√™n Phong C·∫•u', '111100': 'Thi√™n S∆°n ƒê·ªôn', '111000': 'Thi√™n ƒê·ªãa Bƒ©',
            '110000': 'Phong ƒê·ªãa Qu√°n', '100000': 'S∆°n ƒê·ªãa B√°c', '101000': 'Ho·∫£ ƒê·ªãa T·∫•n', '101111': 'Ho·∫£ Thi√™n ƒê·∫°i H·ªØu',
            '011011': 'Thu·∫ßn ƒêo√†i', '011010': 'Tr·∫°ch Th·ªßy Kh·ªën', '011000': 'Tr·∫°ch ƒê·ªãa T·ª•y', '011100': 'Tr·∫°ch S∆°n H√†m',
            '010100': 'Th·ªßy S∆°n Ki·ªÉn', '000100': 'ƒê·ªãa S∆°n Khi√™m', '001100': 'L√¥i S∆°n Ti·ªÉu Qu√°', '001011': 'L√¥i Tr·∫°ch Quy Mu·ªôi',
            '101101': 'Thu·∫ßn Ly', '101100': 'Ho·∫£ S∆°n L·ªØ', '101110': 'Ho·∫£ Phong ƒê·ªânh', '101010': 'Ho·∫£ Th·ªßy V·ªã T·∫ø',
            '100010': 'S∆°n Th·ªßy M√¥ng', '110010': 'Phong Th·ªßy Ho√°n', '111010': 'Thi√™n Th·ªßy T·ª•ng', '111101': 'Thi√™n Ho·∫£ ƒê·ªìng Nh√¢n',
            '001001': 'Thu·∫ßn Ch·∫•n', '001000': 'L√¥i ƒê·ªãa D·ª±', '001010': 'L√¥i Th·ªßy Gi·∫£i', '001110': 'L√¥i Phong H·∫±ng',
            '000110': 'ƒê·ªãa Phong ThƒÉng', '010110': 'Th·ªßy Phong Tƒ©nh', '011110': 'Tr·∫°ch Phong ƒê·∫°i Qu√°', '011001': 'Tr·∫°ch L√¥i T√πy',
            '110110': 'Thu·∫ßn T·ªën', '110111': 'Phong Thi√™n Ti·ªÉu S√∫c', '110101': 'Phong Ho·∫£ Gia Nh√¢n', '110001': 'Phong L√¥i √çch',
            '111001': 'Thi√™n L√¥i V√¥ V·ªçng', '101001': 'Ho·∫£ L√¥i Ph·ªá H·∫°p', '100001': 'S∆°n L√¥i Di', '100110': 'S∆°n Phong C·ªï',
            '010010': 'Thu·∫ßn Kh·∫£m', '010011': 'Th·ªßy Tr·∫°ch Ti·∫øt', '010001': 'Th·ªßy L√¥i Tru√¢n', '010101': 'Th·ªßy Ho·∫£ K√Ω T·∫ø',
            '011101': 'Tr·∫°ch Ho·∫£ C√°ch', '001101': 'L√¥i Ho·∫£ Phong', '000101': 'ƒê·ªãa Ho·∫£ Minh Di', '000010': 'ƒê·ªãa Th·ªßy S∆∞',
            '100100': 'Thu·∫ßn C·∫•n', '100101': 'S∆°n Ho·∫£ B√≠', '100111': 'S∆°n Thi√™n ƒê·∫°i S√∫c', '100011': 'S∆°n Tr·∫°ch T·ªïn',
            '101011': 'Ho·∫£ Tr·∫°ch Khu√™', '111011': 'Thi√™n Tr·∫°ch L√Ω', '110011': 'Phong Tr·∫°ch Trung Phu', '110100': 'Phong S∆°n Ti·ªám',
            '000000': 'Thu·∫ßn Kh√¥n', '000001': 'ƒê·ªãa L√¥i Ph·ª•c', '000011': 'ƒê·ªãa Tr·∫°ch L√¢m', '000111': 'ƒê·ªãa Thi√™n Th√°i',
            '001111': 'L√¥i Thi√™n ƒê·∫°i Tr√°ng', '011111': 'Tr·∫°ch Thi√™n Qu·∫£i', '010111': 'Th·ªßy Thi√™n Nhu', '010000': 'Th·ªßy ƒê·ªãa T·ª∑'
        };

        function flipCoins() {
            const coins = document.querySelectorAll('.coin img');
            const results = [];
            coins.forEach(coin => {
                coin.parentElement.classList.add('flip');
                const isHeads = Math.random() > 0.5;
                results.push(isHeads ? 'duong' : 'am');
                setTimeout(() => {
                    coin.src = isHeads ? headsImage : tailsImage;
                    coin.parentElement.classList.remove('flip');
                }, 3000); // TƒÉng th·ªùi gian l·∫≠t xu l√™n 3s
            });
            return results;
        }

        function gieoQue() {
            const suViec = document.getElementById('su_viec').value;
            const ketQuaDiv = document.getElementById('ket_qua');
            const tenQueDiv = document.getElementById('ten_que');
            const chupButton = document.getElementById('chup-button');

            // Reset giao di·ªán
            ketQuaDiv.innerHTML = `<p>S·ª± vi·ªác: ${suViec || 'Kh√¥ng nh·∫≠p'}</p>`;
            tenQueDiv.innerHTML = '';
            chupButton.style.display = 'none';
            document.getElementById('changed-hexagram').style.display = 'none';

            const lines = [];
            const dongHao = [];
            let haoIndex = 0;

            // T·∫°o 6 h√†o placeholder
            for (let i = 6; i >= 1; i--) {
                const haoDiv = document.createElement('div');
                haoDiv.className = 'hao';
                haoDiv.id = `hao${i}`;
                haoDiv.innerHTML = `H√†o ${i}: `;
                ketQuaDiv.appendChild(haoDiv);
            }

            function tungHao() {
                if (haoIndex < 6) {
                    const coinResults = flipCoins();
                    const sum = coinResults.filter(result => result === 'duong').length;
                    let haoType, haoDisplay, isDong;
                    if (sum === 0) {
                        haoType = 'am';
                        haoDisplay = '<div class="line-container"><div class="yin-line"><div></div><div></div></div><span class="hao-status">(√¢m, ƒë·ªông)</span></div>';
                        isDong = true;
                    } else if (sum === 1) {
                        haoType = 'am';
                        haoDisplay = '<div class="line-container"><div class="yin-line"><div></div><div></div></div><span class="hao-status">(√¢m)</span></div>';
                        isDong = false;
                    } else if (sum === 2) {
                        haoType = 'duong';
                        haoDisplay = '<div class="line-container"><div class="yang-line"></div><span class="hao-status">(d∆∞∆°ng)</span></div>';
                        isDong = false;
                    } else {
                        haoType = 'duong';
                        haoDisplay = '<div class="line-container"><div class="yang-line"></div><span class="hao-status">(d∆∞∆°ng, ƒë·ªông)</span></div>';
                        isDong = true;
                    }

                    lines.push({ type: haoType, isDong: isDong });
                    if (isDong) dongHao.push(haoIndex + 1);

                    const haoToUpdate = document.getElementById(`hao${haoIndex + 1}`);
                    haoToUpdate.innerHTML = `H√†o ${haoIndex + 1}: ${haoDisplay}`;
                    if (isDong) haoToUpdate.classList.add('hao-dong');

                    haoIndex++;

                    if (haoIndex < 6) {
                        setTimeout(tungHao, 6000); // TƒÉng th·ªùi gian ch·ªù gi·ªØa h√†o l√™n 6s
                    } else {
                        // T√≠nh qu·∫ª ch·ªß
                        const binaryLines = lines.map(line => line.type === 'duong' ? '1' : '0').reverse();
                        const thuongQuai = [binaryLines[0], binaryLines[1], binaryLines[2]].join('');
                        const haQuai = [binaryLines[3], binaryLines[4], binaryLines[5]].join('');
                        const queKepCode = thuongQuai + haQuai;

                        const tenThuongQuai = queDon[thuongQuai] || 'Kh√¥ng x√°c ƒë·ªãnh';
                        const tenHaQuai = queDon[haQuai] || 'Kh√¥ng x√°c ƒë·ªãnh';
                        const tenQueKep = queKep[queKepCode] || 'Kh√¥ng x√°c ƒë·ªãnh';

                        let displayText = `Qu·∫ª ch·ªß: ${tenQueKep} (Th∆∞·ª£ng: ${tenThuongQuai}, H·∫°: ${tenHaQuai})`;
                        if (dongHao.length > 0) {
                            displayText += `, ƒë·ªông h√†o ${dongHao.sort((a, b) => a - b).join(', ')}`;
                        } else {
                            displayText += ', kh√¥ng c√≥ h√†o ƒë·ªông';
                        }
                        tenQueDiv.innerHTML = displayText;
                        chupButton.style.display = 'block';

                        // T√≠nh v√† hi·ªÉn th·ªã qu·∫ª bi·∫øn n·∫øu c√≥ h√†o ƒë·ªông
                        if (dongHao.length > 0) {
                            const changedBinaryLines = binaryLines.map((bit, index) => {
                                const lineIndex = 6 - index; // Chuy·ªÉn v·ªÅ th·ª© t·ª± h√†o (1-6)
                                if (dongHao.includes(lineIndex)) {
                                    return bit === '1' ? '0' : '1'; // D∆∞∆°ng ƒë·ªông th√†nh √¢m, √¢m ƒë·ªông th√†nh d∆∞∆°ng
                                }
                                return bit;
                            });
                            const changedThuongQuai = [changedBinaryLines[0], changedBinaryLines[1], changedBinaryLines[2]].join('');
                            const changedHaQuai = [changedBinaryLines[3], changedBinaryLines[4], changedBinaryLines[5]].join('');
                            const changedQueKepCode = changedThuongQuai + changedHaQuai;
                            const changedTenQueKep = queKep[changedQueKepCode] || 'Kh√¥ng x√°c ƒë·ªãnh';
                            const changedTenThuongQuai = queDon[changedThuongQuai] || 'Kh√¥ng x√°c ƒë·ªãnh';
                            const changedTenHaQuai = queDon[changedHaQuai] || 'Kh√¥ng x√°c ƒë·ªãnh';

                            const changedHexagramDiv = document.getElementById('changed-hexagram');
                            const changedHexagramName = document.getElementById('changed-hexagram-name');
                            const changedHexagramLines = document.getElementById('changed-hexagram-lines');

                            changedHexagramName.textContent = `Qu·∫ª bi·∫øn: ${changedTenQueKep} (Th∆∞·ª£ng: ${changedTenThuongQuai}, H·∫°: ${changedTenHaQuai})`;
                            changedHexagramLines.innerHTML = '';

                            for (let i = 6; i >= 1; i--) {
                                const haoDiv = document.createElement('div');
                                haoDiv.className = 'hao';
                                const bitIndex = 6 - i; // Ch·ªâ s·ªë trong changedBinaryLines (0-5)
                                const bit = changedBinaryLines[bitIndex];
                                let lineHTML = `H√†o ${i}: `;
                                if (bit === '1') {
                                    lineHTML += '<div class="line-container"><div class="yang-line"></div><span class="hao-status">(d∆∞∆°ng)</span></div>';
                                } else {
                                    lineHTML += '<div class="line-container"><div class="yin-line"><div></div><div></div></div><span class="hao-status">(√¢m)</span></div>';
                                }
                                haoDiv.innerHTML = lineHTML;
                                changedHexagramLines.appendChild(haoDiv);
                            }
                            changedHexagramDiv.style.display = 'block';
                        }
                    }
                }
            }

            tungHao();
        }

        // T·ª± ƒë·ªông tung xu khi t·∫£i trang
        setInterval(flipCoins, 3000);

        function chupQue() {
            try {
                const tenque = document.getElementById("ten_que");
                const ketqua = document.getElementById("ket_qua");
                const changedHexagram = document.getElementById("changed-hexagram");
                if (!tenque || !ketqua) {
                    alert("Ch∆∞a c√≥ k·∫øt qu·∫£ qu·∫ª ƒë·ªÉ ch·ª•p. Vui l√≤ng gieo qu·∫ª tr∆∞·ªõc.");
                    return;
                }

                // Th·ªùi gian hi·ªán t·∫°i (01:22 AM +07, 26/09/2025)
                let now = new Date();
                let hours = String(now.getHours()).padStart(2, '0');
                let minutes = String(now.getMinutes()).padStart(2, '0');
                let day = String(now.getDate()).padStart(2, '0');
                let month = String(now.getMonth() + 1).padStart(2, '0');
                let year = now.getFullYear();
                let text = `${hours}h${minutes} ; ${day}:${month}:${year}`;

                // V√πng t·∫°m (off-screen)
                const tmp = document.createElement("div");
                tmp.style.position = "fixed";
                tmp.style.left = "-9999px";
                tmp.style.top = "0";
                tmp.style.background = "#ffffff";
                tmp.style.padding = "12px";
                tmp.style.boxSizing = "border-box";
                tmp.style.fontFamily = "'Noto Serif Vietnamese', serif";

                // Th√™m d√≤ng th·ªùi gian (m√†u xanh, ƒë·∫≠m)
                const timeDiv = document.createElement("div");
                timeDiv.textContent = text;
                timeDiv.style.fontSize = "18px";
                timeDiv.style.fontWeight = "bold";
                timeDiv.style.marginBottom = "10px";
                timeDiv.style.color = "#008000";
                tmp.appendChild(timeDiv);

                // Th√™m s·ª± vi·ªác
                const suViecDiv = document.createElement("div");
                suViecDiv.textContent = `S·ª± vi·ªác: ${document.getElementById('su_viec').value || 'Kh√¥ng nh·∫≠p'}`;
                suViecDiv.style.fontSize = "16px";
                suViecDiv.style.marginBottom = "10px";
                tmp.appendChild(suViecDiv);

                // Th√™m qu·∫ª ch·ªß
                tmp.appendChild(tenque.cloneNode(true));
                tmp.appendChild(ketqua.cloneNode(true));

                // Th√™m qu·∫ª bi·∫øn n·∫øu c√≥
                if (changedHexagram.style.display !== 'none') {
                    tmp.appendChild(changedHexagram.cloneNode(true));
                }

                document.body.appendChild(tmp);

                html2canvas(tmp, {
                    useCORS: true,
                    scale: window.devicePixelRatio || 2,
                    backgroundColor: "#ffffff"
                })
                .then(canvas => {
                    if (typeof canvas.toBlob === "function" && "download" in document.createElement("a")) {
                        canvas.toBlob(function(blob) {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement("a");
                            a.href = url;
                            a.download = "que_kinh_dich.png";
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => {
                                URL.revokeObjectURL(url);
                                if (a.parentNode) a.parentNode.removeChild(a);
                                if (tmp.parentNode) tmp.parentNode.removeChild(tmp);
                            }, 150);
                        }, "image/png");
                    } else {
                        const dataUrl = canvas.toDataURL("image/png");
                        const img = new Image();
                        img.src = dataUrl;
                        img.style.maxWidth = "100%";
                        img.style.display = "block";
                        img.style.margin = "12px auto";
                        document.body.appendChild(img);
                        alert("üëâ Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ t·∫£i tr·ª±c ti·∫øp.\nNh·∫•n gi·ªØ v√†o ·∫£nh ƒë·ªÉ l∆∞u v·ªÅ m√°y.");
                        if (tmp.parentNode) tmp.parentNode.removeChild(tmp);
                    }
                })
                .catch(err => {
                    if (tmp.parentNode) tmp.parentNode.removeChild(tmp);
                    console.error("html2canvas error:", err);
                    alert("Ch·ª•p ·∫£nh th·∫•t b·∫°i ‚Äî ki·ªÉm tra console.");
                });
            } catch (e) {
                console.error(e);
                alert("L·ªói n·ªôi b·ªô: " + (e && e.message ? e.message : e));
            }
        }
    </script>
</body>
</html>
