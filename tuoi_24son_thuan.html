<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Hệ Thống Bát Trạch 24 Sơn Tổng Hợp</title>
<style>
:root {
 --color-kham:#1e88e5; --color-kim:#ffdb58; --color-tho:#8d6e63;
 --color-moc:#43a047; --color-hoa:#e91e63; --color-trung:#d4a373;
 --bad:#ff5252; --good:#27ae60;
}
body{font-family:'Segoe UI';background:#f0f2f5;display:flex;justify-content:center;padding:20px}
.container{background:#fff;padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.15);width:550px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:20px 0}
.cell{aspect-ratio:1;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;font-weight:bold}
#c4{background:#43a047} #c9{background:#e91e63} #c2{background:#8d6e63}
#c3{background:#43a047} #c5{background:#d4a373;border:2px solid gold}
#c7{background:#ffdb58;color:#333} #c8{background:#8d6e63}
#c1{background:#1e88e5} #c6{background:#ffdb58;color:#333}
.tag{font-size:11px;padding:3px;margin-top:4px;background:rgba(255,255,255,.9);color:#333;border-radius:4px}
.analysis{background:#fffdf0;padding:15px;border-left:5px solid #b22222}
.son-item{display:flex;justify-content:space-between;padding:6px;border-bottom:1px solid #eee}
.hung{color:var(--bad);font-weight:bold}
.cat{color:var(--good);font-weight:bold}
select,input{width:100%;padding:8px;margin-top:5px}
</style>
</head>
<body>

<div class="container">
<h2 style="text-align:center;color:#b22222">PHONG THỦY 24 SƠN – LƯỜNG THIÊN XÍCH</h2>

<div class="grid">
 <div class="cell" id="c4">4-Tốn<div id="v4"></div></div>
 <div class="cell" id="c9">9-Ly<div id="v9"></div></div>
 <div class="cell" id="c2">2-Khôn<div id="v2"></div></div>
 <div class="cell" id="c3">3-Chấn<div id="v3"></div></div>
 <div class="cell" id="c5">5-Trung<div id="v5"></div></div>
 <div class="cell" id="c7">7-Đoài<div id="v7"></div></div>
 <div class="cell" id="c8">8-Cấn<div id="v8"></div></div>
 <div class="cell" id="c1">1-Khảm<div id="v1"></div></div>
 <div class="cell" id="c6">6-Càn<div id="v6"></div></div>
</div>

<label>Năm sinh</label>
<input type="number" id="txtNam" value="1984" onchange="run()">

<label>Giới tính</label>
<select id="selGioiTinh" onchange="run()">
 <option value="nam">Nam</option>
 <option value="nu">Nữ</option>
</select>

<label>Tháng Tiết Khí</label>
<select id="selThang" onchange="run()"></select>

<label>Tuổi xét</label>
<select id="selTuoi" onchange="run()"></select>

<div id="analysisBox" class="analysis"></div>
</div>

<script>
const hoaGiap=[/* giữ nguyên 60 hoa giáp */"Giáp Tý","Ất Sửu","Bính Dần","Đinh Mão","Mậu Thìn","Kỷ Tị","Canh Ngọ","Tân Mùi","Nhâm Thân","Quý Dậu","Giáp Tuất","Ất Hợi","Bính Tý","Đinh Sửu","Mậu Dần","Kỷ Mão","Canh Thìn","Tân Tị","Nhâm Ngọ","Quý Mùi","Giáp Thân","Ất Dậu","Bính Tuất","Đinh Hợi","Mậu Tý","Kỷ Sửu","Canh Dần","Tân Mão","Nhâm Thìn","Quý Tị","Giáp Ngọ","Ất Mùi","Bính Thân","Đinh Dậu","Mậu Tuất","Kỷ Hợi","Canh Tý","Tân Sửu","Nhâm Dần","Quý Mão","Giáp Thìn","Ất Tị","Bính Ngọ","Đinh Mùi","Mậu Thân","Kỷ Dậu","Canh Tuất","Tân Hợi","Nhâm Tý","Quý Sửu","Giáp Dần","Ất Mão","Bính Thìn","Đinh Tị","Mậu Ngọ","Kỷ Mùi","Canh Thân","Tân Dậu","Nhâm Tuất","Quý Hợi"];

const ltx=[5,6,7,8,9,1,2,3,4];

const tenQuai={1:"Khảm",2:"Khôn",3:"Chấn",4:"Tốn",6:"Càn",7:"Đoài",8:"Cấn",9:"Ly"};

const mappingSonQuai={
1:{sons:[{s:"Nhâm",q:"6"},{s:"Tý",q:"1"},{s:"Quý",q:"2"}]},
2:{sons:[{s:"Mùi",q:"3"},{s:"Khôn",q:"2"},{s:"Thân",q:"1"}]},
3:{sons:[{s:"Giáp",q:"6"},{s:"Mão",q:"3"},{s:"Ất",q:"2"}]},
4:{sons:[{s:"Thìn",q:"1"},{s:"Tốn",q:"4"},{s:"Tỵ",q:"7"}]},
6:{sons:[{s:"Tuất",q:"9"},{s:"Càn",q:"6"},{s:"Hợi",q:"3"}]},
7:{sons:[{s:"Canh",q:"3"},{s:"Dậu",q:"7"},{s:"Tân",q:"4"}]},
8:{sons:[{s:"Sửu",q:"7"},{s:"Cấn",q:"8"},{s:"Dần",q:"9"}]},
9:{sons:[{s:"Bính",q:"8"},{s:"Ngọ",q:"9"},{s:"Đinh",q:"7"}]}
};

const duNienMatrix={/* giữ nguyên bảng Du Niên của bạn */};

function init(){
 const sT=selThang,sU=selTuoi;
 hoaGiap.forEach(v=>{sT.add(new Option(v,v));sU.add(new Option(v,v))});
 sT.value="Mậu Tý"; sU.value="Giáp Tý";
 run();
}

function run(){
 for(let i=1;i<=9;i++) if(document.getElementById("v"+i)) document.getElementById("v"+i).innerHTML="";

 const thang=selThang.value, tuoi=selTuoi.value;
 const idxT=hoaGiap.indexOf(thang), idxU=hoaGiap.indexOf(tuoi);

 // ====== CHỈ SỬA CHỖ NÀY ======
 let diff=idxU-idxT;
 if(diff<0) diff+=60;
 let cungDich=ltx[diff%9];
 // ============================

 document.getElementById("v"+cungDich).innerHTML=`<div class="tag">${tuoi}</div>`;
 document.getElementById("v5").innerHTML=`<div class="tag">Gốc: ${thang}</div>`;

 let html=`<b>Tuổi đáo cung ${cungDich} (${tenQuai[cungDich]})</b><br><br>`;
 mappingSonQuai[cungDich].sons.forEach(item=>{
   let sao=duNienMatrix["1"]?.[item.q]||"";
   let hung=["Tuyệt mệnh","Ngũ quỷ","Họa hại","Lục sát"].includes(sao);
   html+=`<div class="son-item">
     <span>Sơn ${item.s}</span>
     <span class="${hung?'hung':'cat'}">${sao}</span>
   </div>`;
 });
 analysisBox.innerHTML=html;
}

window.onload=init;
</script>
</body>
</html>