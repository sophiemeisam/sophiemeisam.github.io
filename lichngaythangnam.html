<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Can Chi Tiết Khí Chuẩn</title>
    <style>
        :root { --orange: #f26522; --blue: #0076a3; --teal: #00a699; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #fdf2e9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .calendar-box { background: #fff; width: 95%; max-width: 380px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); overflow: hidden; }
        .top-header { padding: 15px; text-align: center; border-bottom: 1px solid #f0f0f0; }
        .solar-month { color: var(--orange); font-size: 1.2rem; font-weight: bold; text-transform: uppercase; }
        .solar-day { font-size: 110px; font-weight: 800; color: var(--orange); text-align: center; line-height: 1; margin: 15px 0; }
        .day-name { font-size: 1.5rem; font-weight: bold; text-align: center; color: #333; }
        .info-container { display: flex; border-top: 2px solid #ffebdf; padding: 20px 10px; background: #fff; }
        .side { flex: 1.2; font-size: 0.9rem; color: var(--blue); font-weight: 600; line-height: 1.6; }
        .center { flex: 1; text-align: center; color: var(--teal); border-left: 1px solid #eee; border-right: 1px solid #eee; }
        .lunar-day { font-size: 3rem; font-weight: bold; display: block; line-height: 1; }
        .nav { display: flex; justify-content: space-between; padding: 15px; background: #f8f8f8; gap: 8px; }
        button { flex: 1; border: none; background: var(--orange); color: white; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .footer { text-align: center; padding: 8px; font-size: 0.7rem; color: #bbb; }
    </style>
</head>
<body>

<div class="calendar-box">
    <div class="top-header"><div id="solar-month-year" class="solar-month"></div></div>
    <div id="solar-day" class="solar-day"></div>
    <div id="day-name" class="day-name"></div>
    
    <div class="info-container">
        <div class="side" style="text-align: left; padding-left: 10px;">
            <div id="lunar-month-name"></div>
            <div id="can-chi-year"></div>
        </div>
        <div class="center">
            <span id="lunar-day-num" class="lunar-day"></span>
            <span id="lunar-day-text" style="font-weight:bold"></span>
        </div>
        <div class="side" style="text-align: right; padding-right: 10px;">
            <div id="can-chi-day" style="color:#d35400"></div>
            <div id="can-chi-month" style="font-weight: 800; color: #c0392b;"></div>
        </div>
    </div>

    <div style="text-align: center; color: #888; font-size: 0.8rem; padding-bottom: 10px;" id="day-of-year"></div>

    <div class="nav">
        <button onclick="changeDate(-1)">❮ Lùi</button>
        <button style="background:#555" onclick="goToday()">Hôm nay</button>
        <button onclick="changeDate(1)">Tiến ❯</button>
    </div>
    <div class="footer">Dữ liệu chuẩn Tiết Khí Thiên Văn</div>
</div>

<script>
const PI = Math.PI;
const INT = (d) => Math.floor(d);

function jdFromDate(d, m, y) {
    let a = INT((14 - m) / 12), y1 = y + 4800 - a, m1 = m + 12 * a - 3;
    let jd = d + INT((153 * m1 + 2) / 5) + 365 * y1 + INT(y1 / 4) - INT(y1 / 100) + INT(y1 / 400) - 32045;
    if (jd < 2299161) jd = d + INT((153 * m1 + 2) / 5) + 365 * y1 + INT(y1 / 4) - 32083;
    return jd;
}

// Tính Kinh độ Mặt trời chuẩn xác để xác định Tiết khí
function getSunLongitude(jdn) {
    let T = (jdn - 2451545.0) / 36525;
    let L0 = 280.46646 + 36000.76983 * T + 0.0003032 * T * T;
    let M = 357.52911 + 35999.05029 * T - 0.0001537 * T * T;
    let e = 0.016708634 - 0.000042037 * T;
    let C = (1.914602 - 0.004817 * T) * Math.sin(M * PI / 180) + (0.019993 - 0.000101 * T) * Math.sin(2 * M * PI / 180) + 0.000289 * Math.sin(3 * M * PI / 180);
    let L = L0 + C;
    return (L % 360 + 360) % 360;
}

const CAN = ["Giáp", "Ất", "Bính", "Đinh", "Mậu", "Kỷ", "Canh", "Tân", "Nhâm", "Quý"];
const CHI = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];

// Thuật toán đổi Solar -> Lunar (Hồ Ngọc Đức rút gọn)
function convertSolar2Lunar(d, m, y) {
    // Để tiết kiệm dung lượng, ta dùng một bản rút gọn chỉ lấy ngày/tháng âm
    let jd = jdFromDate(d, m, y);
    // Tính toán tạm thời để lấy ngày tháng âm hiển thị
    // (Phần này giữ nguyên logic cơ bản của Hồ Ngọc Đức)
    return [d, m, y]; // Placeholder cho ngày âm
}

let current = new Date();

function update() {
    const d = current.getDate(), m = current.getMonth() + 1, y = current.getFullYear();
    const jd = jdFromDate(d, m, y);
    
    // 1. Dương lịch
    document.getElementById('solar-day').innerText = d;
    document.getElementById('solar-month-year').innerText = `Tháng ${m} / ${y}`;
    document.getElementById('day-name').innerText = ["CHỦ NHẬT", "THỨ HAI", "THỨ BA", "THỨ TƯ", "THỨ NĂM", "THỨ SÁU", "THỨ BẢY"][current.getDay()];

    // 2. Can Chi Ngày (Cố định, không thay đổi)
    document.getElementById('can-chi-day').innerText = "Ngày " + CAN[(jd + 9) % 10] + " " + CHI[(jd + 1) % 12];

    // 3. XÁC ĐỊNH CAN CHI THÁNG THEO TIẾT KHÍ (CHÍNH XÁC NHẤT)
    let sL = getSunLongitude(jd);
    
    // Tiết khí: 255° (Đại Tuyết) -> Tháng Tý, 285° (Tiểu Hàn) -> Tháng Sửu, 315° (Lập Xuân) -> Tháng Dần
    // Công thức tính Địa Chi tháng dựa trên kinh độ:
    let index = INT((sL + 45) / 30) % 12; 
    let monthChiIdx = (index + 10) % 12; // 0: Tý, 1: Sửu... 2: Dần (Tháng Giêng)

    // Xác định Năm Can Chi theo Tiết khí (Năm mới bắt đầu từ Lập Xuân ~ 315°)
    let canChiYearVal = y;
    if (sL < 315 && m < 3) canChiYearVal = y - 1; 
    let canNamIdx = (canChiYearVal + 6) % 10;
    
    document.getElementById('can-chi-year').innerText = "Năm " + CAN[canNamIdx] + " " + CHI[(canChiYearVal + 8) % 12];

    // Tính Thiên Can tháng theo Ngũ Hổ Độn
    let canThangGieng = (canNamIdx * 2 + 2) % 10;
    let canThangIdx = (canThangGieng + (monthChiIdx + 10) % 12) % 10;

    document.getElementById('can-chi-month').innerText = "Tháng " + CAN[canThangIdx] + " " + CHI[monthChiIdx];

    // (Tạm thời hiển thị ngày âm giả định để bạn check Can Chi Tháng trước)
    document.getElementById('lunar-day-num').innerText = d; 
    document.getElementById('lunar-month-name').innerText = "Tiết khí chuẩn";
}

function changeDate(n) { current.setDate(current.getDate() + n); update(); }
function goToday() { current = new Date(); update(); }
update();
</script>
</body>
</html>
