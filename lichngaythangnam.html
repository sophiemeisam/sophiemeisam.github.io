<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Vạn Niên Chuẩn 2025</title>
    <style>
        :root { --orange: #f26522; --blue: #0076a3; --teal: #00a699; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #fdf2e9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .calendar-box { background: #fff; width: 95%; max-width: 380px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); overflow: hidden; }
        .top-header { padding: 15px; text-align: center; border-bottom: 1px solid #f0f0f0; }
        .solar-month { color: var(--orange); font-size: 1.2rem; font-weight: bold; text-transform: uppercase; }
        .solar-day { font-size: 110px; font-weight: 800; color: var(--orange); text-align: center; line-height: 1; margin: 15px 0; }
        .day-name { font-size: 1.5rem; font-weight: bold; text-align: center; color: #333; }
        .info-container { display: flex; border-top: 2px solid #ffebdf; padding: 20px 10px; background: #fff; }
        .side { flex: 1.2; font-size: 0.9rem; color: var(--blue); font-weight: 600; line-height: 1.6; }
        .center { flex: 1; text-align: center; color: var(--teal); border-left: 1px solid #eee; border-right: 1px solid #eee; }
        .lunar-day { font-size: 3rem; font-weight: bold; display: block; line-height: 1; }
        .nav { display: flex; justify-content: space-between; padding: 15px; background: #f8f8f8; gap: 8px; }
        button { flex: 1; border: none; background: var(--orange); color: white; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .footer { text-align: center; padding: 8px; font-size: 0.7rem; color: #bbb; }
    </style>
</head>
<body>

<div class="calendar-box">
    <div class="top-header"><div id="solar-month-year" class="solar-month"></div></div>
    <div id="solar-day" class="solar-day"></div>
    <div id="day-name" class="day-name"></div>
    
    <div class="info-container">
        <div class="side" style="text-align: left; padding-left: 10px;">
            <div id="lunar-month-name"></div>
            <div id="can-chi-year"></div>
        </div>
        <div class="center">
            <span id="lunar-day-num" class="lunar-day"></span>
            <span id="lunar-day-text" style="font-weight:bold"></span>
        </div>
        <div class="side" style="text-align: right; padding-right: 10px;">
            <div id="can-chi-day" style="color:#d35400"></div>
            <div id="can-chi-month"></div>
        </div>
    </div>

    <div style="text-align: center; color: #888; font-size: 0.8rem; padding-bottom: 10px;" id="day-of-year"></div>

    <div class="nav">
        <button onclick="changeDate(-1)">❮ Lùi</button>
        <button style="background:#555" onclick="goToday()">Hôm nay</button>
        <button onclick="changeDate(1)">Tiến ❯</button>
    </div>
    <div class="footer">Dữ liệu thuật toán: Hồ Ngọc Đức</div>
</div>

<script>
/* THUẬT TOÁN GỐC ĐÃ FIX LỖI NHẢY THÁNG */
const INT = (d) => Math.floor(d);
function jdFromDate(d, m, y) {
    let a = INT((14 - m) / 12), y1 = y + 4800 - a, m1 = m + 12 * a - 3;
    let jd = d + INT((153 * m1 + 2) / 5) + 365 * y1 + INT(y1 / 4) - INT(y1 / 100) + INT(y1 / 400) - 32045;
    if (jd < 2299161) jd = d + INT((153 * m1 + 2) / 5) + 365 * y1 + INT(y1 / 4) - 32083;
    return jd;
}

function getNewMoonDay(k, tz) {
    let T = k / 1236.85, dr = Math.PI/180;
    let Jd1 = 2415020.75933 + 29.53058868 * k + 0.0001178 * T * T;
    let M = (359.2242 + 29.10535608 * k)*dr, Mpr = (306.0253 + 385.81691806 * k)*dr, F = (21.2964 + 390.67050646 * k)*dr;
    let C1 = (0.1734 - 0.000393 * T) * Math.sin(M) - 0.4068 * Math.sin(Mpr) + 0.0104 * Math.sin(2 * F);
    return INT(Jd1 + C1 + 0.5 + tz / 24);
}

function SunLongitude(jdn) {
    let T = (jdn - 2451545.0) / 36525, dr = Math.PI / 180;
    let L = (280.46645 + 36000.76983 * T + (1.9146 * Math.sin((357.5291 + 35999.0503 * T) * dr))) * dr;
    return L - Math.PI * 2 * INT(L / (Math.PI * 2));
}

function getLunarMonth11(y, tz) {
    let off = jdFromDate(31, 12, y) - 2415021, k = INT(off / 29.530588853);
    let nm = getNewMoonDay(k, tz);
    if (INT(SunLongitude(nm - 0.5 - tz / 24) / Math.PI * 6) >= 9) nm = getNewMoonDay(k - 1, tz);
    return nm;
}

function convertSolar2Lunar(d, m, y, tz) {
    let jd = jdFromDate(d, m, y), k = INT((jd - 2415021.07) / 29.530588);
    let monthStart = getNewMoonDay(k + 1, tz);
    if (monthStart > jd) monthStart = getNewMoonDay(k, tz);
    let a11 = getLunarMonth11(y, tz), ly = y;
    if (a11 >= monthStart) a11 = getLunarMonth11(y - 1, tz); else ly = y + 1;
    let ld = jd - monthStart + 1, diff = INT((monthStart - a11) / 29), lm = diff + 11;
    if (lm > 12) lm -= 12;
    if (lm >= 11 && diff < 4) ly -= 1;
    return [ld, lm, ly];
}

const CAN = ["Giáp", "Ất", "Bính", "Đinh", "Mậu", "Kỷ", "Canh", "Tân", "Nhâm", "Quý"];
const CHI = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];

function update() {
    const d = current.getDate(), m = current.getMonth() + 1, y = current.getFullYear();
    const jd = jdFromDate(d, m, y);
    const lunar = convertSolar2Lunar(d, m, y, 7.0);
    
    document.getElementById('solar-day').innerText = d;
    document.getElementById('solar-month-year').innerText = `Tháng ${m} / ${y}`;
    document.getElementById('day-name').innerText = ["CHỦ NHẬT", "THỨ HAI", "THỨ BA", "THỨ TƯ", "THỨ NĂM", "THỨ SÁU", "THỨ BẢY"][current.getDay()];

    document.getElementById('lunar-day-num').innerText = lunar[0];
    const monthNames = ["Giêng", "Hai", "Ba", "Tư", "Năm", "Sáu", "Bảy", "Tám", "Chín", "Mười", "Mười Một", "Chạp"];
    document.getElementById('lunar-month-name').innerText = "Tháng " + monthNames[lunar[1]-1];

    // Năm Can Chi
    document.getElementById('can-chi-year').innerText = "Năm " + CAN[(lunar[2] + 6) % 10] + " " + CHI[(lunar[2] + 8) % 12];
    
    // Ngày Can Chi
    document.getElementById('can-chi-day').innerText = "Ngày " + CAN[(jd + 9) % 10] + " " + CHI[(jd + 1) % 12];
    
    // THÁNG CAN CHI (Sửa lỗi logic nhảy tháng)
    // Tháng Tý (11 âm) luôn ứng với Can tương ứng của năm theo Ngũ hổ độn
    let canNam = (lunar[2] + 6) % 10;
    let canThangGieng = (canNam * 2 + 2) % 10;
    // Tháng âm lịch m (Giêng=1, Hai=2...) tương ứng chi: m+1
    // Can tháng = (CanThangGieng + m - 1) % 10
    let canThangIdx = (canThangGieng + lunar[1] - 1) % 10;
    let chiThangIdx = (lunar[1] + 1) % 12;
    document.getElementById('can-chi-month').innerText = "Tháng " + CAN[canThangIdx] + " " + CHI[chiThangIdx];

    const startYear = new Date(y, 0, 0);
    document.getElementById('day-of-year').innerText = `Ngày thứ ${Math.floor((current - startYear) / 86400000)} của năm ${y}`;
}

let current = new Date();
function changeDate(n) { current.setDate(current.getDate() + n); update(); }
function goToday() { current = new Date(); update(); }
update();
</script>
</body>
</html>
