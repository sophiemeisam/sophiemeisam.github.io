<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·∫£i B√†i Tarot - ƒê√¥ng T√¢y Vibes (Final Optimized)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --color-primary: #5A189A; /* T√≠m ƒë·∫≠m */
            --color-accent: #FFC300; /* V√†ng */
            --color-text: #333;
            --color-background: #f4f7f9;
            --base-font-size: 1.05rem; 
            --heading-font-size: 1.8rem;
            --menu-font-size: 1.1rem; 
            --font-weight-bold: 700;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            padding: 20px;
            text-align: center;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--color-primary);
            margin-bottom: 25px;
            font-size: 2.5rem; 
            font-weight: var(--font-weight-bold);
            border-bottom: 3px solid var(--color-accent);
            display: inline-block;
            padding-bottom: 5px;
        }

        /* --- Menu Ch√≠nh --- */
        .main-menu-bar {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .main-menu-bar a {
            color: var(--color-primary);
            font-size: var(--menu-font-size);
            font-weight: var(--font-weight-bold);
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .main-menu-bar a:hover {
            background-color: #eee;
            color: var(--color-accent);
        }

        .controls {
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .controls h3 {
            color: var(--color-primary);
            margin-bottom: 10px;
            font-size: var(--heading-font-size);
            font-weight: var(--font-weight-bold);
        }

        .card-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px; 
        }

        .card-buttons button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 15px 25px; 
            border-radius: 10px;
            cursor: pointer;
            font-size: var(--base-font-size);
            font-weight: var(--font-weight-bold);
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .card-buttons button:disabled {
            background-color: #A083C5;
            cursor: not-allowed;
            transform: none;
        }

        .card-buttons button:hover:not(:disabled) {
            background-color: #7B3EAB;
            transform: translateY(-2px);
        }

        .result-area {
            margin-top: 30px;
            border-top: 2px dashed var(--color-primary);
            padding-top: 20px;
            text-align: left;
        }

        #spread-title {
            color: var(--color-primary);
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: var(--font-weight-bold);
            text-align: center;
        }

        #entropy-info { 
            font-style: italic;
            color: #7B3EAB;
            margin-bottom: 15px;
            text-align: center;
        }
        
        #drawing-status {
            color: var(--color-primary);
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        #cards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px; 
            margin-bottom: 20px;
            min-height: 250px; 
        }
        
        /* --- C·∫•u tr√∫c L·∫≠t B√†i 3D --- */
        .card-item {
            width: 160px; 
            height: 220px; 
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            cursor: default;
            position: relative;
            perspective: 1000px; 
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 3.0s; 
            transform-style: preserve-3d; 
        }
        
        .card-back, .card-content {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; 
            border-radius: 12px;
        }

        .card-back {
            background-color: var(--color-primary); 
            border: 3px solid #ccc; 
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            z-index: 2;
        }
        
        .card-back i {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .card-content {
            background-color: #fff;
            border: 3px solid var(--color-accent); 
            padding: 12px;
            transform: rotateY(180deg); 
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .card-item.revealed .card-inner {
            transform: rotateY(180deg);
        }

        /* ƒê·ªãnh d·∫°ng n·ªôi dung b√†i */
        .card-content strong {
            display: block;
            font-size: 1.2rem; 
            color: var(--color-primary);
            margin-bottom: 8px;
            font-weight: var(--font-weight-bold);
        }

        .card-content .card-name {
            display: block;
            font-size: 1.0rem; 
            font-weight: 600; 
            color: var(--color-text);
            flex-grow: 1; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .card-content .card-orientation {
            display: block;
            font-size: 0.9rem;
            color: #888;
            margin-top: 5px;
        }
        
        /* Khu v·ª±c nh·∫≠p Entropy (Form) */
        #entropy-form-container, #custom-spread-form-container {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .entropy-box {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            max-width: 450px;
            width: 90%;
            text-align: left;
        }

        .entropy-box h4 {
            color: var(--color-primary);
            margin-bottom: 15px;
            font-size: 1.4rem;
            text-align: center;
        }
        
        .entropy-box p {
            margin-bottom: 10px; 
            font-size: 1.0rem;
        }

        #entropy-note {
            font-size: 0.9rem;
            color: #5A189A;
            font-style: italic;
            margin-bottom: 20px;
        }

        .entropy-box button {
            width: 100%;
        }

        #submit-entropy, #submit-custom-spread {
            margin-top: 15px;
        }

        #entropy-input, #num-cards-input, #deck-select, #orientation-select, #custom-entropy-input, #custom-deck-select, #custom-orientation-select {
            width: 100%; 
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid var(--color-accent);
            border-radius: 8px;
            font-size: 1.1rem;
            text-align: center;
            box-sizing: border-box;
        }


        /* Khu v·ª±c AI Selection & L·ªãch s·ª≠ */
        .ai-selection {
            margin-top: 40px;
            padding: 25px;
            border: 2px dashed var(--color-primary);
            border-radius: 12px;
            background-color: #f8f0ff;
            text-align: center;
            display: none; 
        }

        .ai-selection button {
            background-color: var(--color-accent);
            color: var(--color-primary);
            border: none;
            padding: 15px 30px; 
            border-radius: 8px;
            cursor: pointer;
            font-weight: 900; 
            margin: 0 10px;
            transition: background-color 0.2s;
            font-size: 1.2rem; 
        }
        
        .ai-selection button:hover {
            background-color: #FFD740;
        }

        #history-area {
            margin-top: 40px;
            padding: 25px;
            border-top: 2px dashed var(--color-primary);
            text-align: left;
        }
        #history-area h3 {
            color: var(--color-primary);
            text-align: center;
        }
        .history-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .history-item strong {
            color: var(--color-primary);
            display: block;
            margin-bottom: 5px;
        }


        .notes {
            margin-top: 40px;
            padding: 25px;
            background-color: #e6f7ff;
            border-left: 5px solid var(--color-primary);
            text-align: left;
            border-radius: 8px;
        }
        
        @media (max-width: 600px) {
            .card-item {
                width: 100%;
                max-width: 140px;
                height: 180px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="main-menu-bar">
            <a href="https://chudich.github.io/IChing2.html"><i class="fas fa-home"></i> Trang Ch·ªß</a>
            <a href="#controls"><i class="fas fa-magic"></i> R√∫t B√†i Tarot</a>
            <a href="#" id="history-link"><i class="fas fa-history"></i> L·ªãch S·ª≠</a>
        </div>

        <h1>üîÆ Tr·∫£i B√†i Tarot</h1>
        
        <div class="controls" id="controls">
            <h3>Ch·ªçn Ph∆∞∆°ng Ph√°p Tr·∫£i B√†i:</h3>
            <div class="card-buttons">
                <button id="btn-1-card" data-num="1" data-name="Tr·∫£i B√†i NƒÉng L∆∞·ª£ng S·ª± Vi·ªác C·ª• Th·ªÉ">1 L√°: S·ª± Vi·ªác</button>
                <button id="btn-3-card" data-num="3" data-name="Tr·∫£i B√†i Ph√¢n T√≠ch S·ª± Vi·ªác">3 L√°: Ph√¢n T√≠ch S·ª± Vi·ªác</button>
                <button id="btn-7-card" data-num="7" data-name="Tr·∫£i B√†i Tarot 1 Tu·∫ßn">7 L√°: 1 Tu·∫ßn</button>
                <button id="btn-4-card" data-num="4" data-name="Tr·∫£i B√†i Tarot 1 Th√°ng">4 L√°: 1 Th√°ng</button>
                <button id="btn-6-card" data-num="6" data-name="Tr·∫£i B√†i Tarot 3 Th√°ng">6 L√°: 3 Th√°ng</button>
                <button id="btn-10-card" data-num="10" data-name="Tr·∫£i B√†i Tarot 6 Th√°ng">10 L√°: 6 Th√°ng</button>
                <button id="btn-12-card" data-num="12" data-name="Tr·∫£i B√†i Tarot 1 NƒÉm">12 L√°: 1 NƒÉm</button>
                <button id="btn-custom"><i class="fas fa-cog"></i> L√° B√†i T√πy Ch·ªânh</button>
            </div>
        </div>

        <div id="result-area" class="result-area" style="display: none;">
            <div id="spread-title"></div>
            <div id="entropy-info"></div> 
            <div id="drawing-status" style="display: none;">ƒêang r√∫t l√° b√†i...</div>
            <div id="cards-container"></div>
            
            <div class="ai-selection" id="ai-selection">
                <p>K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c sao ch√©p v√†o b·ªô nh·ªõ t·∫°m. H√£y ch·ªçn AI ƒë·ªÉ gi·∫£i b√†i:</p>
                <button onclick="openAI('Gemini')">Gi·∫£i b·∫±ng Gemini</button>
                <button onclick="openAI('ChatGPT')">Gi·∫£i b·∫±ng ChatGPT</button>
                <div id="copy-message" style="display: none; color: green; margin-top: 10px;">ƒê√£ sao ch√©p!</div>
            </div>
            
            <div id="card-info" class="card-info" style="font-style: italic; color: #666; margin-bottom: 20px; text-align: center;"></div>
        </div>
        
        <div id="history-area" style="display: none;">
            <h3><i class="fas fa-book-open"></i> L·ªãch S·ª≠ R√∫t B√†i</h3>
            <div id="history-list"></div>
            <button onclick="clearHistory()" style="background-color: #ccc; color: #333; border: none; padding: 10px 20px; border-radius: 5px; margin-top: 15px;">X√≥a L·ªãch S·ª≠</button>
        </div>


        <div class="notes">
            <strong>Ch√∫ th√≠ch v·ªÅ Khung th·ªùi gian:</strong>
            <p>Tr·∫£i b√†i **1 Tu·∫ßn** bao g·ªìm t·ª´ Th·ª© Hai ƒë·∫øn Ch·ªß Nh·∫≠t ti·∫øp theo.</p>
            <p>Tr·∫£i b√†i **1 Th√°ng** bao g·ªìm t·ª´ Ng√†y 1 ƒë·∫øn cu·ªëi th√°ng hi·ªán t·∫°i.</p>
            <p>Tr·∫£i b√†i **3 Th√°ng** bao g·ªìm th√°ng hi·ªán t·∫°i v√† 2 th√°ng k·∫ø ti·∫øp.</p>
            <p>Tr·∫£i b√†i **6 Th√°ng** bao g·ªìm th√°ng hi·ªán t·∫°i v√† 5 th√°ng k·∫ø ti·∫øp.</p>
            <p>Tr·∫£i b√†i **1 NƒÉm** b·∫Øt ƒë·∫ßu t·ª´ Th√°ng hi·ªán t·∫°i v√† k√©o d√†i 12 th√°ng li√™n t·ª•c.</p> </div>
    </div>

    <div id="entropy-form-container" style="display: none;">
        <div class="entropy-box">
            <h4 id="entropy-title">NƒÉng L∆∞·ª£ng K·∫øt N·ªëi</h4>
            <p>Vui l√≤ng nh·∫≠p **m·ªôt t·ª´, m·ªôt c·ª•m t·ª´, ho·∫∑c m·ªôt con s·ªë** b·∫•t k·ª≥ li√™n quan ƒë·∫øn v·∫•n ƒë·ªÅ b·∫°n mu·ªën h·ªèi ƒë·ªÉ k·∫øt n·ªëi nƒÉng l∆∞·ª£ng:</p>
            <div id="entropy-note">T·ª´ kh√≥a n√†y gi√∫p c√° nh√¢n h√≥a k·∫øt qu·∫£ gi·∫£i b√†i c·ªßa AI.</div>
            <input type="text" id="entropy-input" placeholder="V√≠ d·ª•: ƒë√™m trƒÉng, 11, c√¢u h·ªèi c·ªßa t√¥i..." autofocus>
            <p>Ch·ªçn B·ªô B√†i:</p>
            <select id="deck-select">
                <option value="Rider-Waite">Tarot Rider-Waite</option>
                <option value="Oracle">Oracle Cards (H·ªá th·ªëng Kh√°c)</option>
            </select>
            <p>T√πy ch·ªçn H∆∞·ªõng B√†i Ng∆∞·ª£c:</p>
            <select id="orientation-select">
                <option value="enabled">B·∫≠t (Xu√¥i & Ng∆∞·ª£c)</option>
                <option value="disabled">T·∫Øt (Ch·ªâ Xu√¥i)</option>
            </select>
            <button id="submit-entropy">R√∫t B√†i</button>
        </div>
    </div>
    
    <div id="custom-spread-form-container" style="display: none;">
        <div class="entropy-box">
            <h4>Tr·∫£i B√†i T√πy Ch·ªânh</h4>
            <p>Nh·∫≠p s·ªë l∆∞·ª£ng l√° b√†i b·∫°n mu·ªën r√∫t (t·ª´ 1 ƒë·∫øn 12):</p>
            <input type="number" id="num-cards-input" min="1" max="12" value="4">
            <p>V√† nh·∫≠p t·ª´ kh√≥a k·∫øt n·ªëi nƒÉng l∆∞·ª£ng:</p>
            <input type="text" id="custom-entropy-input" placeholder="T·ª´ kh√≥a..." autofocus>
             <p>Ch·ªçn B·ªô B√†i:</p>
            <select id="custom-deck-select">
                <option value="Rider-Waite">Tarot Rider-Waite</option>
                <option value="Oracle">Oracle Cards (H·ªá th·ªëng Kh√°c)</option>
            </select>
            <p>T√πy ch·ªçn H∆∞·ªõng B√†i Ng∆∞·ª£c:</p>
            <select id="custom-orientation-select">
                <option value="enabled">B·∫≠t (Xu√¥i & Ng∆∞·ª£c)</option>
                <option value="disabled">T·∫Øt (Ch·ªâ Xu√¥i)</option>
            </select>
            <button id="submit-custom-spread">R√∫t B√†i T√πy Ch·ªânh</button>
        </div>
    </div>

    <script>
        // --- D·ªÆ LI·ªÜU B·ªò B√ÄI M·ªû R·ªòNG & V·ªä TR√ç ---
        const MAJOR_ARCANA = [
            '0 - The Fool', 'I - The Magician', 'II - The High Priestess', 'III - The Empress', 
            'IV - The Emperor', 'V - The Hierophant', 'VI - The Lovers', 'VII - The Chariot', 
            'VIII - Strength', 'IX - The Hermit', 'X - Wheel of Fortune', 'XI - Justice', 
            'XII - The Hanged Man', 'XIII - Death', 'XIV - Temperance', 'XV - The Devil', 
            'XVI - The Tower', 'XVII - The Star', 'XVIII - The Moon', 'XIX - The Sun', 
            'XX - Judgement', 'XXI - The World'
        ];
        const MINOR_ARCANA_SUITS = ['Wands', 'Cups', 'Swords', 'Pentacles'];
        const CARD_RANKS = ['Ace', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Page', 'Knight', 'Queen', 'King'];
        const ORACLE_CARDS = [
             'The Vision', 'The Journey', 'The Anchor', 'The Light', 'The Shadow', 'The Gift', 'The Storm', 'The Calm', 'The Barrier', 'The Bridge'
        ];
        
        const MONTH_NAMES = ['Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6', 
                             'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'];

        const SPREAD_POSITIONS_MAP_DETAIL = {
            'Tr·∫£i B√†i NƒÉng L∆∞·ª£ng S·ª± Vi·ªác C·ª• Th·ªÉ': ['NƒÉng L∆∞·ª£ng Ch√≠nh (C√¢u tr·∫£ l·ªùi c·ªët l√µi)'],
            'Tr·∫£i B√†i Ph√¢n T√≠ch S·ª± Vi·ªác': ['L√° 1: Qu√° Kh·ª© (G·ªëc r·ªÖ v·∫•n ƒë·ªÅ)', 'L√° 2: Hi·ªán T·∫°i (C·ªët l√µi v·∫•n ƒë·ªÅ & NƒÉng l∆∞·ª£ng hi·ªán t·∫°i)', 'L√° 3: T∆∞∆°ng Lai (Ti·ªÅm nƒÉng/K·∫øt qu·∫£)'],
            'Tr·∫£i B√†i Tarot 1 Tu·∫ßn': ['Th·ª© Hai (Kh·ªüi ƒë·∫ßu)', 'Th·ª© Ba (NƒÉng l∆∞·ª£ng ti·∫øn tri·ªÉn)', 'Th·ª© T∆∞ (ƒêi·ªÉm xoay/Gi·ªØa tu·∫ßn)', 'Th·ª© NƒÉm (M·ªü r·ªông/B√†i h·ªçc)', 'Th·ª© S√°u (Th√†nh t·ª±u/C√¢n b·∫±ng)', 'Th·ª© B·∫£y (Ngh·ªâ ng∆°i/Tƒ©nh l·∫∑ng)', 'Ch·ªß Nh·∫≠t (K·∫øt th√∫c/ƒê√∫c k·∫øt)'],
            'Tr·∫£i B√†i Tarot 1 Th√°ng': ['Tu·∫ßn 1: Kh·ªüi ƒë·ªông', 'Tu·∫ßn 2: Th·ª≠ th√°ch', 'Tu·∫ßn 3: ƒê·ªânh cao/H√†nh ƒë·ªông', 'Tu·∫ßn 4: K·∫øt qu·∫£/Nh·∫≠n th·ª©c'],
        };
        
        // --- Bi·∫øn Chung & Khai b√°o To√†n c·ª•c quan tr·ªçng ---
        const DRAW_DELAY = 3000; 
        
        // Khai b√°o c√°c bi·∫øn DOM
        let allButtons;
        let cardsContainer;
        let resultArea;
        let drawingStatus;
        let aiSelection;
        let historyList;
        let entropyInfo;
        
        let entropyFormContainer;
        let entropyInput;
        let submitEntropyButton;
        let deckSelect;
        let orientationSelect;

        let customSpreadFormContainer;
        let numCardsInput;
        let customEntropyInput;
        let submitCustomSpreadButton;
        let customDeckSelect;
        let customOrientationSelect;
        
        // Bi·∫øn tr·∫°ng th√°i
        let currentNumCards = 0;
        let currentSpreadName = '';
        let currentDrawnCards = [];
        let currentDeckType = 'Rider-Waite';
        let currentOrientation = 'enabled';
        
        // Bi·∫øn Entropy/Seed 
        let entropyHash = 0; 
        let seed = 1; 
        let startTimeEntropy = 0; 

        // --- H√ÄM ENTROPY TƒÇNG C∆Ø·ªúNG ---
        function generateHash(input) {
            let hash = 2166136261; 
            for (let i = 0; i < input.length; i++) {
                hash ^= input.charCodeAt(i);
                hash = Math.imul(hash, 16777619);
            }
            return hash >>> 0; 
        }

        function seededRandomWithHash() {
            // ƒê·∫£m b·∫£o startTimeEntropy kh√¥ng ph·∫£i l√† 0 ho·∫∑c null khi t√≠nh to√°n
            const timeFactor = startTimeEntropy || 1; // S·ª≠ d·ª•ng 1 n·∫øu ch∆∞a ƒë∆∞·ª£c g√°n ch√≠nh x√°c
            seed = (seed * 9301 + 49297 + entropyHash + timeFactor) % 233280;
            entropyHash = (entropyHash + seed) & 0xFFFFFFFF; 
            return seed / 233280;
        }
        // --- K·∫æT TH√öC THU·∫¨T TO√ÅN ENTROPY ---
        
        // --- Logic Show Form (ƒê√£ ki·ªÉm tra l·∫°i) ---
        function showEntropyForm(numCards, spreadName) {
            currentNumCards = numCards;
            currentSpreadName = spreadName;
            
            allButtons.forEach(button => button.disabled = true);
            
            document.getElementById('entropy-title').textContent = `K·∫øt n·ªëi nƒÉng l∆∞·ª£ng cho ${spreadName}`;
            entropyInput.value = '';
            // S·ª≠ d·ª•ng check: if (entropyFormContainer)
            if (entropyFormContainer) {
                entropyFormContainer.style.display = 'flex';
            }
            if (customSpreadFormContainer) {
                 customSpreadFormContainer.style.display = 'none';
            }
            if (entropyInput) {
                entropyInput.focus();
            }

            startTimeEntropy = new Date().getTime();
        }
        
        function showCustomSpreadForm() {
            allButtons.forEach(button => button.disabled = true);
            if (entropyFormContainer) {
                entropyFormContainer.style.display = 'none';
            }
            if (customSpreadFormContainer) {
                customSpreadFormContainer.style.display = 'flex';
            }
            if (customEntropyInput) {
                customEntropyInput.focus();
            }

            startTimeEntropy = new Date().getTime();
        }

        // --- H√†m R√∫t B√†i Ch√≠nh ---
        function drawCards(numCards, spreadName, entropyValue) {
            
            // L·∫•y th·ªùi gian nh·∫≠p li·ªáu ch√≠nh x√°c
            const endTimeEntropy = new Date().getTime();
            startTimeEntropy = endTimeEntropy - startTimeEntropy;
            
            // Guard clause: ƒê·∫£m b·∫£o c√°c DOM elements quan tr·ªçng kh√¥ng ph·∫£i l√† null
            if (!resultArea || !cardsContainer || !drawingStatus || !entropyInfo || !aiSelection) {
                console.error("L·ªói DOM: Kh√¥ng t√¨m th·∫•y m·ªôt ho·∫∑c nhi·ªÅu ph·∫ßn t·ª≠ k·∫øt qu·∫£. Vui l√≤ng ki·ªÉm tra l·∫°i ID trong HTML.");
                allButtons.forEach(button => button.disabled = false);
                return;
            }

            document.getElementById('history-area').style.display = 'none';
            resultArea.style.display = 'block';
            
            aiSelection.style.display = 'none';
            cardsContainer.innerHTML = ''; 
            drawingStatus.style.display = 'block';
            document.getElementById('spread-title').textContent = `${spreadName.toUpperCase()} - B·ªò B√ÄI: ${currentDeckType.toUpperCase()}`;
            
            entropyInfo.innerHTML = `**T·ª´ kh√≥a NƒÉng l∆∞·ª£ng:** "${entropyValue || 'NƒÉng l∆∞·ª£ng ng·∫´u nhi√™n'}"`;

            const infoElement = document.getElementById('card-info');
            infoElement.innerHTML = '';

            const deck = createDeck(currentDeckType);
            currentDrawnCards = [];
            currentSpreadName = spreadName;
            
            const indices = Array.from({ length: deck.length }, (_, i) => i);
            
            for (let i = 0; i < numCards; i++) {
                
                if (indices.length === 0) break;

                const randomIndex = Math.floor(seededRandomWithHash() * indices.length);
                const cardIndexInDeck = indices[randomIndex];
                
                indices.splice(randomIndex, 1); 

                const card = deck[cardIndexInDeck]; 
                
                const orientation = (currentOrientation === 'enabled' && seededRandomWithHash() < 0.5) ? 'R' : 'U'; 
                const positionName = getPositionName(spreadName, i, numCards);
                
                currentDrawnCards.push({
                    name: card,
                    orientation: orientation,
                    position: positionName
                });
                
                const cardItem = document.createElement('div');
                cardItem.className = 'card-item';
                cardItem.id = `card-idx-${i}`;
                cardItem.innerHTML = `
                    <div class="card-inner">
                        <div class="card-back">
                            <i class="fas fa-hand-sparkles"></i>
                            <span>${positionName}</span>
                        </div>
                        <div class="card-content">
                        </div>
                    </div>
                `;
                cardsContainer.appendChild(cardItem);
            }
            
            for (let i = 0; i < numCards; i++) {
                const delay = (i + 1) * DRAW_DELAY; 
                
                setTimeout(() => {
                    revealCard(i, numCards);
                }, delay);
            }

            setTimeout(() => {
                saveToHistory(spreadName, currentDrawnCards, currentDeckType, entropyValue);
            }, (numCards * DRAW_DELAY) + 1000); 
        }

        // --- H√†m L·∫≠t B√†i v√† K·∫øt qu·∫£ (Gi·ªØ nguy√™n) ---
        function revealCard(index, totalCards) {
            const cardData = currentDrawnCards[index];
            const cardItem = document.getElementById(`card-idx-${index}`);
            
            if (!cardData || !cardItem) return;

            drawingStatus.textContent = `ƒêang r√∫t l√° b√†i th·ª© ${index + 1} / ${totalCards}...`;

            const orientationText = cardData.orientation === 'U' ? 'Xu√¥i' : 'Ng∆∞·ª£c';
            
            const contentDiv = cardItem.querySelector('.card-content');
            contentDiv.innerHTML = `
                <strong>${cardData.position}</strong>
                <span class="card-name">${cardData.name}</span>
                <span class="card-orientation">(${orientationText})</span>
            `;

            cardItem.classList.add('revealed');

            if (index === totalCards - 1) {
                setTimeout(() => {
                    drawingStatus.style.display = 'none';
                    displayFinalResults();
                    allButtons.forEach(button => button.disabled = false); 
                    copyToClipboard();
                }, 1000); 
            }
        }
        
        // --- H√†m L·∫•y T√™n V·ªã tr√≠ T·ªëi ∆∞u (Gi·ªØ nguy√™n) ---
        function getPositionName(spreadName, index, numCards) {
            if (SPREAD_POSITIONS_MAP_DETAIL[spreadName]) {
                return SPREAD_POSITIONS_MAP_DETAIL[spreadName][index] || `V·ªã tr√≠ ${index + 1}`;
            }

            if (spreadName === 'Tr·∫£i B√†i Tarot 3 Th√°ng') {
                const months3 = [getMonthName(0), getMonthName(1), getMonthName(2)];
                const positions3 = [
                    `${months3[0]} (Hi·ªán t·∫°i)`, `${months3[1]} (Ti·ªÅm nƒÉng)`, `${months3[2]} (K·∫øt qu·∫£ d·ª± ki·∫øn)`, 
                    'Th√°ch th·ª©c c·∫ßn v∆∞·ª£t qua', 'C∆° h·ªôi s·∫Øp t·ªõi', 'K·∫øt qu·∫£ t·ªïng quan'
                ];
                return positions3[index] || `V·ªã tr√≠ ${index + 1}`;
            }
            
            if (spreadName === 'Tr·∫£i B√†i Tarot 6 Th√°ng') {
                return `Th√°ng ${index + 1}: ${getMonthName(index)}`;
            }
            
            if (spreadName === 'Tr·∫£i B√†i Tarot 1 NƒÉm') {
                return `${getMonthName(index)} (${index === 0 ? 'Th√°ng hi·ªán t·∫°i' : 'D·ª± ki·∫øn'})`;
            }

            if (spreadName.startsWith('Tr·∫£i B√†i T√πy Ch·ªânh')) {
                return `V·ªã tr√≠ ${index + 1} / ${numCards}`;
            }

            return `V·ªã tr√≠ ${index + 1}`;
        }

        // --- C√°c H√†m Ph·ª• (Gi·ªØ nguy√™n) ---
        function createDeck(deckType) {
            if (deckType === 'Oracle') {
                return [...ORACLE_CARDS];
            }
            let deck = [...MAJOR_ARCANA];
            for (const suit of MINOR_ARCANA_SUITS) {
                for (const rank of CARD_RANKS) {
                    deck.push(`${rank} of ${suit}`);
                }
            }
            return deck;
        }

        function getMonthName(offset = 0) {
            const date = new Date();
            const currentMonthIndex = date.getMonth();
            const targetMonthIndex = (currentMonthIndex + offset) % 12; 
            const targetYear = date.getFullYear() + Math.floor((currentMonthIndex + offset) / 12); 
            return `${MONTH_NAMES[targetMonthIndex]} ${targetYear}`;
        }

        function displayFinalResults() {
             const cardInfos = currentDrawnCards.map(card => card.position);
             const finalInfoElement = document.getElementById('card-info');
             if (finalInfoElement) {
                 finalInfoElement.innerHTML = `**C√°c v·ªã tr√≠ ƒë√£ r√∫t:** ${cardInfos.join(', ')}`;
             }
             aiSelection.style.display = 'block';
        }

        function copyToClipboard() {
            if (currentDrawnCards.length === 0) return;

            const spreadDetails = currentDrawnCards.map(card => {
                const orientationText = card.orientation === 'U' ? 'Xu√¥i' : 'Ng∆∞·ª£c';
                return `${card.position}: ${card.name} (${orientationText})`;
            }).join('\n');
            
            // L·∫•y gi√° tr·ªã entropy t·ª´ input
            let entropyValue = (entropyInput && entropyInput.value.trim() || customEntropyInput && customEntropyInput.value.trim()) || 'NƒÉng l∆∞·ª£ng ng·∫´u nhi√™n';

            const copyText = `${currentSpreadName} (B·ªô b√†i: ${currentDeckType}):\n${spreadDetails}\n\n[Y√™u c·∫ßu gi·∫£i b√†i chi ti·∫øt d·ª±a tr√™n c√°c l√° b√†i ƒë√£ r√∫t n√†y, k·∫øt h·ª£p v·ªõi t·ª´ kh√≥a: "${entropyValue}" ]`;

            navigator.clipboard.writeText(copyText).then(() => {
                const copyMessage = document.getElementById('copy-message');
                copyMessage.style.display = 'block';
                setTimeout(() => {
                    copyMessage.style.display = 'none';
                }, 3000);
            }).catch(err => {
                console.error('Kh√¥ng th·ªÉ sao ch√©p vƒÉn b·∫£n: ', err);
                alert('T·ª± ƒë·ªông sao ch√©p th·∫•t b·∫°i. Vui l√≤ng sao ch√©p th·ªß c√¥ng:\n' + copyText);
            });
        }
        
        function getHistory() {
            const history = localStorage.getItem('tarot_history');
            return history ? JSON.parse(history) : [];
        }

        function saveToHistory(spreadName, cards, deckType, entropyValue) {
            const history = getHistory();
            const timestamp = new Date().toLocaleString('vi-VN');
            
            history.unshift({
                timestamp,
                spreadName,
                deckType,
                entropyValue,
                cards
            });
            
            if (history.length > 10) {
                history.pop();
            }

            localStorage.setItem('tarot_history', JSON.stringify(history));
        }

        function showHistory() {
            resultArea.style.display = 'none';
            document.getElementById('history-area').style.display = 'block';
            
            const history = getHistory();
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #999;">Ch∆∞a c√≥ l∆∞·ª£t r√∫t b√†i n√†o ƒë∆∞·ª£c l∆∞u.</p>';
                return;
            }

            history.forEach(item => {
                const cardDetails = item.cards.map(card => {
                    const orientationText = card.orientation === 'U' ? 'Xu√¥i' : 'Ng∆∞·ª£c';
                    return `<li>${card.position}: ${card.name} (${orientationText})</li>`;
                }).join('');

                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                itemDiv.innerHTML = `
                    <strong>${item.timestamp} - ${item.spreadName}</strong>
                    <p>B·ªô b√†i: ${item.deckType} | T·ª´ kh√≥a: "${item.entropyValue || 'Kh√¥ng c√≥'}"</p>
                    <ul style="list-style: none; padding-left: 0; font-size: 0.95rem;">${cardDetails}</ul>
                `;
                historyList.appendChild(itemDiv);
            });
        }

        function clearHistory() {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ r√∫t b√†i?")) {
                localStorage.removeItem('tarot_history');
                showHistory();
            }
        }
        
        function openAI(aiName) {
            let url = '';
            
            if (aiName === 'Gemini') {
                url = 'https://gemini.google.com/app';
            } else if (aiName === 'ChatGPT') {
                url = 'https://chat.openai.com/';
            }
            
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.style.display = 'none';
            document.body.appendChild(link);

            link.click();
            
            document.body.removeChild(link);
        }
        
        // --- H√ÄM KH·ªûI T·∫†O ƒê·∫¢M B·∫¢O T·∫§T C·∫¢ PH·∫¶N T·ª¨ ƒê√É T·∫¢I ---
        function init() {
            // G√°n gi√° tr·ªã cho c√°c bi·∫øn DOM
            allButtons = document.querySelectorAll('.card-buttons button');
            cardsContainer = document.getElementById('cards-container');
            resultArea = document.getElementById('result-area');
            drawingStatus = document.getElementById('drawing-status');
            aiSelection = document.getElementById('ai-selection');
            historyList = document.getElementById('history-list');
            entropyInfo = document.getElementById('entropy-info');
            
            entropyFormContainer = document.getElementById('entropy-form-container');
            entropyInput = document.getElementById('entropy-input');
            submitEntropyButton = document.getElementById('submit-entropy');
            deckSelect = document.getElementById('deck-select');
            orientationSelect = document.getElementById('orientation-select');

            customSpreadFormContainer = document.getElementById('custom-spread-form-container');
            numCardsInput = document.getElementById('num-cards-input');
            customEntropyInput = document.getElementById('custom-entropy-input');
            submitCustomSpreadButton = document.getElementById('submit-custom-spread');
            customDeckSelect = document.getElementById('custom-deck-select');
            customOrientationSelect = document.getElementById('custom-orientation-select');

            // Kh·ªüi t·∫°o l·∫°i bi·∫øn th·ªùi gian ngay khi init, ƒë·ªÅ ph√≤ng l·ªói
            startTimeEntropy = new Date().getTime(); 

            // G√°n Event Listener cho c√°c n√∫t R√∫t B√†i theo s·ªë l∆∞·ª£ng
            allButtons.forEach(button => {
                if (button.id.startsWith('btn-') && button.id !== 'btn-custom') {
                    button.addEventListener('click', () => {
                        const num = parseInt(button.getAttribute('data-num'), 10);
                        const name = button.getAttribute('data-name');
                        showEntropyForm(num, name);
                    });
                }
            });
            
            // G√°n Event Listener cho n√∫t R√∫t B√†i T√πy Ch·ªânh
            const btnCustom = document.getElementById('btn-custom');
            if(btnCustom) {
                 btnCustom.addEventListener('click', showCustomSpreadForm);
            }

            // G√°n Event Listener cho c√°c n√∫t Submit Form (Ki·ªÉm tra null tr∆∞·ªõc khi g√°n)
            if (submitEntropyButton) {
                submitEntropyButton.addEventListener('click', function() {
                    const entropyValue = entropyInput.value.trim() || 'random_default';
                    currentDeckType = deckSelect.value;
                    currentOrientation = orientationSelect.value;
                    if (entropyFormContainer) entropyFormContainer.style.display = 'none';
                    
                    entropyHash = generateHash(entropyValue);
                    seed = new Date().getTime() % 233280; 
                    
                    drawCards(currentNumCards, currentSpreadName, entropyValue);
                });
            }
            
            if (submitCustomSpreadButton) {
                submitCustomSpreadButton.addEventListener('click', function() {
                    const numCards = parseInt(numCardsInput.value, 10);
                    const entropyValue = customEntropyInput.value.trim() || 'random_default';
                    currentDeckType = customDeckSelect.value;
                    currentOrientation = customOrientationSelect.value;
                    
                    if (isNaN(numCards) || numCards < 1 || numCards > 12) {
                        alert("S·ªë l∆∞·ª£ng l√° b√†i ph·∫£i t·ª´ 1 ƒë·∫øn 12.");
                        return;
                    }

                    if (customSpreadFormContainer) customSpreadFormContainer.style.display = 'none';
                    
                    entropyHash = generateHash(entropyValue);
                    seed = new Date().getTime() % 233280; 
                    
                    drawCards(numCards, `Tr·∫£i B√†i T√πy Ch·ªânh (${numCards} L√°)`, entropyValue);
                });
            }
            
            // G√°n Event Listener cho n√∫t L·ªãch s·ª≠
            const historyLink = document.getElementById('history-link');
            if (historyLink) {
                historyLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    showHistory();
                });
            }
        }

        // Ch·∫Øc ch·∫Øn h√†m init() ƒë∆∞·ª£c g·ªçi sau khi to√†n b·ªô DOM ƒë√£ t·∫£i
        window.addEventListener('load', init);
    </script>
</body>
</html>
