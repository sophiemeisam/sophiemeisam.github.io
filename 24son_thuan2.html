<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Bát Trạch Tinh Hoa - La Bàn 24 Sơn</title>
    <style>
        :root {
            --color-kham: #1e88e5; --color-kim: #f1c40f; --color-tho: #8d6e63;
            --color-moc: #27ae60; --color-hoa: #e74c3c; --bad: #ff5252; --good: #2ecc71;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 750px; display: flex; flex-direction: column; align-items: center; }
        
        /* La bàn 24 Sơn */
        .compass-container { position: relative; width: 400px; height: 400px; margin: 20px 0; border-radius: 50%; border: 8px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.2); background: #fff; }
        .compass-dial { position: absolute; width: 100%; height: 100%; border-radius: 50%; transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .mountain { position: absolute; width: 100%; height: 100%; text-align: center; font-size: 10px; font-weight: bold; padding-top: 5px; box-sizing: border-box; }
        .mountain-line { position: absolute; top: 0; left: 50%; width: 1px; height: 50%; background: rgba(0,0,0,0.1); transform-origin: bottom; }
        .active-sector { background: rgba(255, 235, 59, 0.3); position: absolute; top: 0; left: 50%; width: 52.36px; height: 50%; transform-origin: bottom; margin-left: -26.18px; border-top: 5px solid gold; visibility: hidden; }

        .center-needle { position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; background: #b22222; border-radius: 50%; transform: translate(-50%, -50%); z-index: 10; }
        
        /* Form & Result */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 10px; }
        .son-list { width: 100%; margin-top: 20px; }
        .son-card { background: #fff; border-left: 5px solid #ccc; padding: 12px; margin-bottom: 8px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .info-box { font-size: 13px; color: #666; font-style: italic; }
        .cat { color: var(--good); font-weight: bold; } .hung { color: var(--bad); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align:center; color:#b22222; font-weight:bold; font-size:22px; margin-bottom:10px;">BÁT TRẠCH 24 SƠN TINH HOA</div>

    <div class="compass-container">
        <div class="center-needle"></div>
        <div id="dial" class="compass-dial">
            </div>
        <div id="high1" class="active-sector"></div>
        <div id="high2" class="active-sector"></div>
        <div id="high3" class="active-sector"></div>
    </div>

    <div class="input-grid">
        <div><label>Năm sinh:</label><input type="number" id="txtNam" value="1984" onchange="run()"></div>
        <div><label>Giới tính:</label><select id="selGioiTinh" onchange="run()"><option value="nam">Nam</option><option value="nu">Nữ</option></select></div>
        <div><label>Tháng gốc (Cung 5):</label><select id="selThang" onchange="run()"></select></div>
        <div><label>Tuổi xét (Phi thuận):</label><select id="selTuoi" onchange="run()"></select></div>
    </div>

    <div id="result" class="son-list"></div>
</div>

<script>
const hoaGiap = ["Giáp Tý","Ất Sửu","Bính Dần","Đinh Mão","Mậu Thìn","Kỷ Tị","Canh Ngọ","Tân Mùi","Nhâm Thân","Quý Dậu","Giáp Tuất","Ất Hợi","Bính Tý","Đinh Sửu","Mậu Dần","Kỷ Mão","Canh Thìn","Tân Tị","Nhâm Ngọ","Quý Mùi","Giáp Thân","Ất Dậu","Bính Tuất","Đinh Hợi","Mậu Tý","Kỷ Sửu","Canh Dần","Tân Mão","Nhâm Thìn","Quý Tị","Giáp Ngọ","Ất Mùi","Bính Thân","Đinh Dậu","Mậu Tuất","Kỷ Hợi","Canh Tý","Tân Sửu","Nhâm Dần","Quý Mão","Giáp Thìn","Ất Tị","Bính Ngọ","Đinh Mùi","Mậu Thân","Kỷ Dậu","Canh Tuất","Tân Hợi","Nhâm Tý","Quý Sửu","Giáp Dần","Ất Mão","Bính Thìn","Đinh Tị","Mậu Ngọ","Kỷ Mùi","Canh Thân","Tân Dậu","Nhâm Tuất","Quý Hợi"];
const sonNames = ["Tý","Quý","Sửu","Cấn","Dần","Giáp","Mão","Ất","Thìn","Tốn","Tỵ","Bính","Ngọ","Đinh","Mùi","Khôn","Thân","Canh","Dậu","Tân","Tuất","Càn","Hợi","Nhâm"];
// Mapping góc độ: Tý ở 0 độ (Bắc)
const ltx = [5, 6, 7, 8, 9, 1, 2, 3, 4];
const tenQ = {1:"Khảm", 2:"Khôn", 3:"Chấn", 4:"Tốn", 6:"Càn", 7:"Đoài", 8:"Cấn", 9:"Ly"};

const mappingSonQuai = {
    1: { sons: ["Nhâm", "Tý", "Quý"], nạp: [6, 1, 2], deg: [345, 0, 15] },
    8: { sons: ["Sửu", "Cấn", "Dần"], nạp: [7, 8, 9], deg: [30, 45, 60] },
    3: { sons: ["Giáp", "Mão", "Ất"], nạp: [6, 3, 2], deg: [75, 90, 105] },
    4: { sons: ["Thìn", "Tốn", "Tỵ"], nạp: [1, 4, 7], deg: [120, 135, 150] },
    9: { sons: ["Bính", "Ngọ", "Đinh"], nạp: [8, 9, 7], deg: [165, 180, 195] },
    2: { sons: ["Mùi", "Khôn", "Thân"], nạp: [3, 2, 1], deg: [210, 225, 240] },
    7: { sons: ["Canh", "Dậu", "Tân"], nạp: [3, 7, 4], deg: [255, 270, 285] },
    6: { sons: ["Tuất", "Càn", "Hợi"], nạp: [9, 6, 3], deg: [300, 315, 330] }
};

const matrix = {
    1: {1:"Phục vị", 2:"Tuyệt mệnh", 3:"Thiên y", 4:"Sinh khí", 6:"Lục sát", 7:"Họa hại", 8:"Ngũ quỷ", 9:"Diên niên"},
    2: {1:"Tuyệt mệnh", 2:"Phục vị", 3:"Họa hại", 4:"Ngũ quỷ", 6:"Diên niên", 7:"Thiên y", 8:"Sinh khí", 9:"Lục sát"},
    3: {1:"Thiên y", 2:"Họa hại", 3:"Phục vị", 4:"Diên niên", 6:"Ngũ quỷ", 7:"Tuyệt mệnh", 8:"Lục sát", 9:"Sinh khí"},
    4: {1:"Sinh khí", 2:"Ngũ quỷ", 3:"Diên niên", 4:"Phục vị", 6:"Họa hại", 7:"Lục sát", 8:"Tuyệt mệnh", 9:"Thiên y"},
    6: {1:"Lục sát", 2:"Diên niên", 3:"Ngũ quỷ", 4:"Họa hại", 6:"Phục vị", 7:"Sinh khí", 8:"Thiên y", 9:"Tuyệt mệnh"},
    7: {1:"Họa hại", 2:"Thiên y", 3:"Tuyệt mệnh", 4:"Lục sát", 6:"Sinh khí", 7:"Phục vị", 8:"Diên niên", 9:"Ngũ quỷ"},
    8: {1:"Ngũ quỷ", 2:"Sinh khí", 3:"Lục sát", 4:"Tuyệt mệnh", 6:"Thiên y", 7:"Diên niên", 8:"Phục vị", 9:"Họa hại"},
    9: {1:"Diên niên", 2:"Lục sát", 3:"Sinh khí", 4:"Thiên y", 6:"Tuyệt mệnh", 7:"Ngũ quỷ", 8:"Họa hại", 9:"Phục vị"}
};

function createCompass() {
    const dial = document.getElementById('dial');
    sonNames.forEach((name, i) => {
        let angle = i * 15;
        let el = document.createElement('div');
        el.className = 'mountain';
        el.style.transform = `rotate(${angle}deg)`;
        el.innerHTML = `<span>${name}</span><div class="mountain-line"></div>`;
        dial.appendChild(el);
    });
}

function run() {
    const nam = parseInt(document.getElementById('txtNam').value);
    const gt = document.getElementById('selGioiTinh').value;
    let n = nam % 100;
    let menh = (gt==='nam') ? (100 - n) % 9 : (n + 5) % 9;
    if(menh===0) menh=9; if(menh===5) menh=(gt==='nam'?2:8);

    const thang = document.getElementById('selThang').value;
    const tuoi = document.getElementById('selTuoi').value;
    let jump = (hoaGiap.indexOf(tuoi) - hoaGiap.indexOf(thang) + 60) % 60;
    let cungDich = ltx[jump % 9];

    let html = `<div style="text-align:center; font-weight:bold; margin-bottom:15px; background:#b22222; color:#fff; padding:10px; border-radius:5px;">MỆNH: ${tenQ[menh]} (${menh}) - TUỔI ĐÁO: ${tenQ[cungDich]}</div>`;
    
    // Xoay la bàn để cung đến ở vị trí dễ nhìn (tùy chọn, ở đây giữ cố định để đúng hướng Bắc)
    // Highlight 3 sơn
    for(let i=1; i<=3; i++) document.getElementById('high'+i).style.visibility = 'hidden';

    if(mappingSonQuai[cungDich]) {
        mappingSonQuai[cungDich].sons.forEach((sName, i) => {
            let nQuai = mappingSonQuai[cungDich].nạp[i];
            let sao = matrix[menh][nQuai];
            let isBad = ["Tuyệt mệnh", "Ngũ quỷ", "Họa hại", "Lục sát"].includes(sao);
            
            // Highlight trên La bàn
            let high = document.getElementById('high'+(i+1));
            high.style.visibility = 'visible';
            high.style.transform = `rotate(${mappingSonQuai[cungDich].deg[i]}deg)`;

            html += `
                <div class="son-card" style="border-left-color: ${isBad?'var(--bad)':'var(--good)'}">
                    <div>
                        <div style="font-weight:bold; font-size:16px;">Sơn ${sName}</div>
                        <div class="info-box">Nạp ${tenQ[nQuai]}</div>
                    </div>
                    <div class="${isBad?'hung':'cat'}" style="text-align:right">
                        ${sao}
                    </div>
                </div>`;
        });
    } else {
        html += `<div style="text-align:center; padding:20px;">Tuổi nhập <b>Trung Cung</b> - Không xét Sơn.</div>`;
    }
    document.getElementById('result').innerHTML = html;
}

window.onload = () => {
    const sT = document.getElementById('selThang');
    const sU = document.getElementById('selTuoi');
    hoaGiap.forEach(v => { sT.add(new Option(v, v)); sU.add(new Option(v, v)); });
    sT.value = "Kỷ Sửu"; sU.value = "Giáp Tý";
    createCompass();
    run();
};
</script>
</body>
</html>
