<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinh Dá»‹ch Cáº£m Xáº¡ - Gieo Quáº» ThÃ´ng Minh</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #fff3e0, #ffd6cc);
            color: #333;
        }

        h1 {
            font-family: 'Noto Serif SC', serif;
            font-size: 36px;
            color: #8b0000;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        #input-section {
            margin-bottom: 30px;
            text-align: center;
        }

        #question-input {
            padding: 12px;
            width: 350px;
            font-size: 16px;
            border: 2px solid #8b0000;
            border-radius: 30px;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #question-input:focus {
            border-color: #ff4040;
            box-shadow: 0 0 10px rgba(255, 64, 64, 0.3);
        }

        #pendulum-container {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            touch-action: none; /* NgÄƒn cuá»™n khi vuá»‘t */
        }

        #hand {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #ffd700, #ffaa00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px; /* TÄƒng kÃ­ch thÆ°á»›c bÃ n tay */
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        #hand:hover {
            transform: scale(1.1);
        }

        #string {
            width: 3px;
            height: 180px;
            background: linear-gradient(#FFC1CC, #FFB6C1); /* Gradient há»“ng tháº¡ch anh */
            position: relative;
        }

        #bob {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #FFC1CC, #FF9999); /* Há»“ng tháº¡ch anh */
            border-radius: 50%;
            position: absolute;
            bottom: -20px;
            left: -18.5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        @keyframes swing {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(45deg); } /* TÄƒng biÃªn Ä‘á»™ lÃªn Â±45Â° */
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-45deg); }
            100% { transform: rotate(0deg); }
        }

        .swinging #bob {
            animation: swing 1.8s ease-in-out infinite;
            transform-origin: top center;
        }

        #hexagram-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .hexagram-line {
            display: flex;
            align-items: center;
            margin: 12px 0;
            width: 170px;
            justify-content: flex-start;
            gap: 10px;
        }

        .line-number {
            font-size: 16px;
            font-weight: 600;
            color: #8b0000;
            width: 20px;
            text-align: right;
        }

        .yang-line {
            width: 100px;
            height: 12px;
            background: #ff3333;
            border-radius: 3px;
        }

        .yin-line {
            display: flex;
            gap: 10px;
            width: 100px;
        }

        .yin-line div {
            width: 45px;
            height: 12px;
            background: #333;
            border-radius: 3px;
        }

        .moving-blink {
            animation: blink 0.8s ease-in-out infinite;
            box-shadow: 0 0 8px #ffaa00;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        .yang-moving, .yin-moving {
            position: relative;
        }

        .yang-moving::after, .yin-moving::after {
            content: 'âœ¦';
            font-size: 14px;
            color: #ffaa00;
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
        }

        #hexagram-progress {
            font-size: 18px;
            font-weight: 600;
            color: #8b0000;
            margin-top: 15px;
        }

        #result-section {
            margin-top: 30px;
            text-align: center;
            max-width: 600px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        #result-section h2, #result-section h3 {
            font-family: 'Noto Serif SC', serif;
            color: #8b0000;
        }

        #button-container {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        #gieo-button, #reset-button, #download-button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(45deg, #8b0000, #ff4040);
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #gieo-button:hover, #reset-button:hover, #download-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        #moving-lines {
            font-size: 16px;
            font-weight: 600;
            color: #ff4040;
            margin-top: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .time-stamp {
            color: #00cc00;
            font-weight: bold;
        }

        #changed-hexagram {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @media (max-width: 600px) {
            #question-input {
                width: 90%;
            }

            #pendulum-container {
                width: 250px;
                height: 250px;
            }

            #hexagram-section {
                width: 90%;
            }

            #button-container {
                flex-direction: column;
                gap: 10px;
            }

            .hexagram-line {
                width: 140px;
            }

            .yang-line {
                width: 80px;
            }

            .yin-line {
                width: 80px;
            }

            .yin-line div {
                width: 35px;
            }
        }
    </style>
</head>
<body>
    <h1>Kinh Dá»‹ch Cáº£m Xáº¡</h1>
    <div id="input-section">
        <label for="question-input">Nháº­p sá»± viá»‡c cáº§n kiá»ƒm tra:</label><br>
        <input type="text" id="question-input" placeholder="VÃ­ dá»¥: NÄƒng lÆ°á»£ng cá»§a má»™t sá»± viá»‡c">
    </div>

    <div id="pendulum-container">
        <div id="hand" onclick="toggleSwing()">ðŸ«²</div>
        <div id="string">
            <div id="bob"></div>
        </div>
    </div>

    <div id="button-container">
        <button id="gieo-button" onclick="gieoQue()">Gieo Quáº»</button>
        <button id="reset-button" onclick="resetHexagram()" style="display: none;">Gieo Láº¡i</button>
    </div>
    <div id="moving-lines"></div>

    <div id="hexagram-section">
        <div id="hexagram-lines">
            <div class="hexagram-line"><span class="line-number">6</span><div class="empty-line"></div></div>
            <div class="hexagram-line"><span class="line-number">5</span><div class="empty-line"></div></div>
            <div class="hexagram-line"><span class="line-number">4</span><div class="empty-line"></div></div>
            <div class="hexagram-line"><span class="line-number">3</span><div class="empty-line"></div></div>
            <div class="hexagram-line"><span class="line-number">2</span><div class="empty-line"></div></div>
            <div class="hexagram-line"><span class="line-number">1</span><div class="empty-line"></div></div>
        </div>
        <div id="hexagram-progress">Láº§n gieo: 0/6</div>
    </div>

    <div id="result-section">
        <h2>Káº¿t quáº£ Quáº»</h2>
        <div id="hexagram-name"></div>
        <div id="hexagram-meaning"></div>
        <div id="changed-hexagram">
            <h3>Quáº» Biáº¿n</h3>
            <div id="changed-hexagram-name"></div>
            <div id="changed-hexagram-lines">
                <div class="hexagram-line"><span class="line-number">6</span><div class="empty-line"></div></div>
                <div class="hexagram-line"><span class="line-number">5</span><div class="empty-line"></div></div>
                <div class="hexagram-line"><span class="line-number">4</span><div class="empty-line"></div></div>
                <div class="hexagram-line"><span class="line-number">3</span><div class="empty-line"></div></div>
                <div class="hexagram-line"><span class="line-number">2</span><div class="empty-line"></div></div>
                <div class="hexagram-line"><span class="line-number">1</span><div class="empty-line"></div></div>
            </div>
        </div>
        <button id="download-button" onclick="downloadImage()" style="display: none; margin-top: 20px;">Táº£i áº¢nh</button>
    </div>

    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        let isSwinging = false;
        let hexagramLines = [];
        let hexagramCount = 0;
        let changedLines = [];
        const swingSound = new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3'); // Thay báº±ng URL Ã¢m thanh phÃ¹ há»£p

        // Dá»¯ liá»‡u quáº» Ä‘Æ¡n
        const singleHexagrams = {
            "111": "Kiá»n",
            "011": "ÄoÃ i",
            "101": "Ly",
            "001": "Cháº¥n",
            "110": "Tá»‘n",
            "010": "Kháº£m",
            "100": "Cáº¥n",
            "000": "KhÃ´n"
        };

        // Dá»¯ liá»‡u quáº» kÃ©p
        const doubleHexagrams = {
            "111111": "Thuáº§n Kiá»n",
            "111110": "ThiÃªn Phong Cáº¥u",
            "111100": "ThiÃªn SÆ¡n Äá»™n",
            "111000": "ThiÃªn Äá»‹a BÄ©",
            "110000": "Phong Äá»‹a QuÃ¡n",
            "100000": "SÆ¡n Äá»‹a BÃ¡c",
            "101000": "Hoáº£ Äá»‹a Táº¥n",
            "101111": "Hoáº£ ThiÃªn Äáº¡i Há»¯u",
            "011011": "Thuáº§n ÄoÃ i",
            "011010": "Tráº¡ch Thá»§y Khá»‘n",
            "011000": "Tráº¡ch Äá»‹a Tá»¥y",
            "011100": "Tráº¡ch SÆ¡n HÃ m",
            "010100": "Thá»§y SÆ¡n Kiá»ƒn",
            "000100": "Äá»‹a SÆ¡n KhiÃªm",
            "001100": "LÃ´i SÆ¡n Tiá»ƒu QuÃ¡",
            "001011": "LÃ´i Tráº¡ch Quy Muá»™i",
            "101101": "Thuáº§n Ly",
            "101100": "Hoáº£ SÆ¡n Lá»¯",
            "101110": "Hoáº£ Phong Äá»‰nh",
            "101010": "Hoáº£ Thá»§y Vá»‹ Táº¿",
            "100010": "SÆ¡n Thá»§y MÃ´ng",
            "110010": "Phong Thá»§y HoÃ¡n",
            "111010": "ThiÃªn Thá»§y Tá»¥ng",
            "111101": "ThiÃªn Hoáº£ Äá»“ng NhÃ¢n",
            "001001": "Thuáº§n Cháº¥n",
            "001000": "LÃ´i Äá»‹a Dá»±",
            "001010": "LÃ´i Thá»§y Giáº£i",
            "001110": "LÃ´i Phong Háº±ng",
            "000110": "Äá»‹a Phong ThÄƒng",
            "010110": "Thá»§y Phong TÄ©nh",
            "011110": "Tráº¡ch Phong Äáº¡i QuÃ¡",
            "011001": "Tráº¡ch LÃ´i TÃ¹y",
            "110110": "Thuáº§n Tá»‘n",
            "110111": "Phong ThiÃªn Tiá»ƒu SÃºc",
            "110101": "Phong Hoáº£ Gia NhÃ¢n",
            "110001": "Phong LÃ´i Ãch",
            "111001": "ThiÃªn LÃ´i VÃ´ Vá»ng",
            "101001": "Hoáº£ LÃ´i Phá»‡ Háº¡p",
            "100001": "SÆ¡n LÃ´i Di",
            "100110": "SÆ¡n Phong Cá»•",
            "010010": "Thuáº§n Kháº£m",
            "010011": "Thá»§y Tráº¡ch Tiáº¿t",
            "010001": "Thá»§y LÃ´i TruÃ¢n",
            "010101": "Thá»§y Hoáº£ KÃ½ Táº¿",
            "011101": "Tráº¡ch Hoáº£ CÃ¡ch",
            "001101": "LÃ´i Hoáº£ Phong",
            "000101": "Äá»‹a Hoáº£ Minh Di",
            "000010": "Äá»‹a Thá»§y SÆ°",
            "100100": "Thuáº§n Cáº¥n",
            "100101": "SÆ¡n Hoáº£ BÃ­",
            "100111": "SÆ¡n ThiÃªn Äáº¡i SÃºc",
            "100011": "SÆ¡n Tráº¡ch Tá»•n",
            "101011": "Hoáº£ Tráº¡ch KhuÃª",
            "111011": "ThiÃªn Tráº¡ch LÃ½",
            "110011": "Phong Tráº¡ch Trung Phu",
            "110100": "Phong SÆ¡n Tiá»‡m",
            "000000": "Thuáº§n KhÃ´n",
            "000001": "Äá»‹a LÃ´i Phá»¥c",
            "000011": "Äá»‹a Tráº¡ch LÃ¢m",
            "000111": "Äá»‹a ThiÃªn ThÃ¡i",
            "001111": "LÃ´i ThiÃªn Äáº¡i TrÃ¡ng",
            "011111": "Tráº¡ch ThiÃªn Quáº£i",
            "010111": "Thá»§y ThiÃªn Nhu",
            "010000": "Thá»§y Äá»‹a Tá»·"
        };

        // Dá»¯ liá»‡u Ã½ nghÄ©a quáº»
        const hexagramMeanings = {
            "Thuáº§n Kiá»n": "Biá»ƒu thá»‹ sá»± máº¡nh máº½, sÃ¡ng táº¡o. ÄÃ¢y lÃ  thá»i Ä‘iá»ƒm Ä‘á»ƒ hÃ nh Ä‘á»™ng quyáº¿t Ä‘oÃ¡n, nhÆ°ng cáº§n giá»¯ sá»± cÃ¢n báº±ng.",
            "ThiÃªn Phong Cáº¥u": "Gá»£i Ã½ sá»± gáº·p gá»¡, káº¿t ná»‘i. HÃ£y cáº©n tháº­n trong cÃ¡c má»‘i quan há»‡ má»›i.",
            "ThiÃªn SÆ¡n Äá»™n": "KhuyÃªn báº¡n nÃªn rÃºt lui, báº£o toÃ n nÄƒng lÆ°á»£ng Ä‘á»ƒ chá» thá»i cÆ¡.",
            "ThiÃªn Äá»‹a BÄ©": "Cho tháº¥y sá»± báº¿ táº¯c. Cáº§n kiÃªn nháº«n vÃ  tÃ¬m cÃ¡ch vÆ°á»£t qua khÃ³ khÄƒn.",
            "Tráº¡ch Hoáº£ CÃ¡ch": "Biá»ƒu thá»‹ sá»± thay Ä‘á»•i lá»›n, cáº£i cÃ¡ch. HÃ£y chuáº©n bá»‹ tinh tháº§n cho nhá»¯ng biáº¿n chuyá»ƒn quan trá»ng.",
            "LÃ´i Hoáº£ Phong": "Biá»ƒu thá»‹ sá»± phong phÃº, thá»‹nh vÆ°á»£ng. HÃ£y táº­n dá»¥ng cÆ¡ há»™i nhÆ°ng cáº§n giá»¯ sá»± cÃ¢n báº±ng vÃ  khÃ´ng vá»™i vÃ ng.",
            "ThiÃªn Tráº¡ch LÃ½": "Biá»ƒu thá»‹ sá»± hÃ²a há»£p vÃ  cÃ´ng báº±ng. HÃ£y hÃ nh Ä‘á»™ng Ä‘Ãºng Ä‘áº¯n vÃ  giá»¯ vá»¯ng nguyÃªn táº¯c.",
            "Tráº¡ch Phong Äáº¡i QuÃ¡": "Biá»ƒu thá»‹ sá»± vÆ°á»£t quÃ¡ giá»›i háº¡n, cáº§n tháº­n trá»ng Ä‘á»ƒ trÃ¡nh rá»§i ro vÃ  giá»¯ cÃ¢n báº±ng.",
            "Thuáº§n KhÃ´n": "Biá»ƒu thá»‹ sá»± nhu thuáº­n, kiÃªn nháº«n. HÃ£y láº¯ng nghe vÃ  thÃ­ch nghi vá»›i hoÃ n cáº£nh.",
            "Phong Thá»§y HoÃ¡n": "Biá»ƒu thá»‹ sá»± phÃ¢n tÃ¡n, thay Ä‘á»•i. HÃ£y linh hoáº¡t vÃ  chuáº©n bá»‹ cho sá»± chuyá»ƒn Ä‘á»•i."
        };

        function toggleSwing() {
            if (!isSwinging) {
                isSwinging = true;
                document.getElementById('string').classList.add('swinging');
                swingSound.play().catch(error => console.error('Lá»—i phÃ¡t Ã¢m thanh:', error));
            }
        }

        // Xá»­ lÃ½ cá»­ chá»‰ vuá»‘t
        let touchStartX = 0;
        document.getElementById('pendulum-container').addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });

        document.getElementById('pendulum-container').addEventListener('touchmove', (e) => {
            const touchEndX = e.touches[0].clientX;
            const deltaX = touchEndX - touchStartX;
            if (Math.abs(deltaX) > 30) { // NgÆ°á»¡ng vuá»‘t
                toggleSwing();
            }
        });

        function gieoQue() {
            if (isSwinging) {
                document.getElementById('string').classList.remove('swinging');
                isSwinging = false;

                const states = ['yang', 'yang-moving', 'yin', 'yin-moving'];
                const result = states[Math.floor(Math.random() * 4)];
                hexagramLines.push(result);
                hexagramCount++;
                updateHexagramDisplay();

                if (hexagramCount < 6) {
                    document.getElementById('hexagram-progress').textContent = `Láº§n gieo: ${hexagramCount}/6`;
                } else {
                    showResult();
                    document.getElementById('gieo-button').style.display = 'none';
                    document.getElementById('reset-button').style.display = 'inline-block';
                    document.getElementById('download-button').style.display = 'inline-block';
                }
            }
        }

        function updateHexagramDisplay() {
            const linesContainer = document.getElementById('hexagram-lines');
            const lineElements = linesContainer.getElementsByClassName('hexagram-line');
            for (let i = 0; i < 6; i++) {
                const lineInner = lineElements[5 - i].getElementsByTagName('div')[0];
                if (i < hexagramLines.length) {
                    const line = hexagramLines[i];
                    lineInner.className = '';
                    if (line === 'yang') {
                        lineInner.className = 'yang-line';
                        lineInner.innerHTML = '';
                    } else if (line === 'yang-moving') {
                        lineInner.className = 'yang-line yang-moving moving-blink';
                        lineInner.innerHTML = '';
                    } else if (line === 'yin') {
                        lineInner.className = 'yin-line';
                        lineInner.innerHTML = '<div></div><div></div>';
                    } else if (line === 'yin-moving') {
                        lineInner.className = 'yin-line yin-moving moving-blink';
                        lineInner.innerHTML = '<div></div><div></div>';
                    }
                } else {
                    lineInner.className = 'empty-line';
                    lineInner.innerHTML = '';
                }
            }
        }

        function updateChangedHexagramDisplay(changedLines) {
            const linesContainer = document.getElementById('changed-hexagram-lines');
            const lineElements = linesContainer.getElementsByClassName('hexagram-line');
            for (let i = 0; i < 6; i++) {
                const lineInner = lineElements[5 - i].getElementsByTagName('div')[0];
                const line = changedLines[i];
                lineInner.className = '';
                if (line === 'yang') {
                    lineInner.className = 'yang-line';
                    lineInner.innerHTML = '';
                } else {
                    lineInner.className = 'yin-line';
                    lineInner.innerHTML = '<div></div><div></div>';
                }
            }
        }

        function showResult() {
            document.getElementById('hexagram-progress').textContent = `HoÃ n táº¥t gieo quáº»!`;
            const question = document.getElementById('question-input').value || 'sá»± viá»‡c';

            const hexagramCode = hexagramLines.map(line => line.includes('yang') ? '1' : '0');
            const upperTrigram = [hexagramCode[5], hexagramCode[4], hexagramCode[3]].join('');
            const lowerTrigram = [hexagramCode[2], hexagramCode[1], hexagramCode[0]].join('');
            const hexagramKey = upperTrigram + lowerTrigram;
            const hexagramName = doubleHexagrams[hexagramKey] || "Quáº» KhÃ´ng XÃ¡c Äá»‹nh";
            const hexagramMeaning = hexagramMeanings[hexagramName] || `Dá»±a trÃªn cÃ¢u há»i "${question}", quáº» nÃ y khuyÃªn báº¡n nÃªn suy nghÄ© ká»¹ lÆ°á»¡ng vÃ  tÃ¬m thÃªm thÃ´ng tin trÆ°á»›c khi quyáº¿t Ä‘á»‹nh.`;

            const movingLines = hexagramLines
                .map((line, index) => line.includes('moving') ? index + 1 : null)
                .filter(line => line !== null);

            let changedHexagramName = '';
            changedLines = [...hexagramLines];
            if (movingLines.length > 0) {
                changedLines = hexagramLines.map(line => {
                    if (line === 'yang-moving') return 'yin';
                    if (line === 'yin-moving') return 'yang';
                    return line.replace('-moving', '');
                });
                const changedHexagramCode = changedLines.map(line => line.includes('yang') ? '1' : '0');
                const changedUpperTrigram = [changedHexagramCode[5], changedHexagramCode[4], changedHexagramCode[3]].join('');
                const changedLowerTrigram = [changedHexagramCode[2], changedHexagramCode[1], changedHexagramCode[0]].join('');
                const changedHexagramKey = changedUpperTrigram + changedLowerTrigram;
                changedHexagramName = doubleHexagrams[changedHexagramKey] || "Quáº» Biáº¿n KhÃ´ng XÃ¡c Äá»‹nh";
                updateChangedHexagramDisplay(changedLines);
                document.getElementById('changed-hexagram-name').textContent = changedHexagramName;
                document.getElementById('changed-hexagram').style.display = 'block';
            } else {
                document.getElementById('changed-hexagram').style.display = 'none';
            }

            document.getElementById('hexagram-name').textContent = hexagramName;
            document.getElementById('hexagram-meaning').textContent = hexagramMeaning;
            const movingLinesText = movingLines.length > 0 
                ? `${hexagramName} Ä‘á»™ng hÃ o ${movingLines.join(', ')}`
                : `${hexagramName} (khÃ´ng cÃ³ hÃ o Ä‘á»™ng)`;
            document.getElementById('moving-lines').textContent = movingLinesText;

            document.getElementById('result-section').style.display = 'block';
        }

        function downloadImage() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            const scale = 2;
            canvas.width = 600 * scale;
            canvas.height = 900 * scale;
            ctx.scale(scale, scale);

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 600, 900);
            ctx.strokeStyle = '#8b0000';
            ctx.lineWidth = 2;
            ctx.strokeRect(10, 10, 580, 880);

            ctx.font = 'bold 24px "Noto Serif SC"';
            ctx.fillStyle = '#8b0000';
            ctx.textAlign = 'center';
            ctx.fillText('Kinh Dá»‹ch Cáº£m Xáº¡', 300, 40);

            const question = document.getElementById('question-input').value || 'Sá»± viá»‡c';
            ctx.font = '16px Poppins';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'left';
            ctx.fillText(`Sá»± viá»‡c: ${question.substring(0, 50)}...`, 20, 80);

            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2, '0')}h${now.getMinutes().toString().padStart(2, '0')} ${now.getDate().toString().padStart(2, '0')}:${(now.getMonth() + 1).toString().padStart(2, '0')}:${now.getFullYear()}`;
            ctx.font = 'bold 16px Poppins';
            ctx.fillStyle = '#00cc00';
            ctx.fillText(timeStr, 20, 110);

            ctx.font = 'bold 20px "Noto Serif SC"';
            ctx.fillStyle = '#ff3333';
            ctx.fillText('Quáº» ChÃ­nh: ' + document.getElementById('hexagram-name').textContent, 20, 150);
            drawHexagram(ctx, hexagramLines, 20, 180);

            if (document.getElementById('changed-hexagram').style.display !== 'none') {
                ctx.fillStyle = '#333';
                ctx.fillText('Quáº» Biáº¿n: ' + document.getElementById('changed-hexagram-name').textContent, 20, 400);
                drawHexagram(ctx, changedLines, 20, 430);
            }

            ctx.font = '16px Poppins';
            ctx.fillStyle = '#ff4040';
            ctx.fillText(document.getElementById('moving-lines').textContent, 20, 650);

            try {
                const dataURL = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `QueDich_${document.getElementById('hexagram-name').textContent}.png`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert('áº¢nh Ä‘Ã£ Ä‘Æ°á»£c táº£i vá»!');
            } catch (error) {
                console.error('Lá»—i khi táº£i áº£nh:', error);
                alert('CÃ³ lá»—i xáº£y ra khi táº£i áº£nh. Vui lÃ²ng thá»­ láº¡i!');
            }
        }

        function drawHexagram(ctx, lines, x, y) {
            for (let i = 5; i >= 0; i--) {
                const line = lines[i];
                ctx.fillStyle = line.includes('yang') ? '#ff3333' : '#333';
                if (line.includes('yang')) {
                    ctx.fillRect(x, y, 100, 12);
                } else {
                    ctx.fillRect(x, y, 45, 12);
                    ctx.fillRect(x + 55, y, 45, 12);
                }
                if (line.includes('moving')) {
                    ctx.fillStyle = '#ffaa00';
                    ctx.font = '16px Poppins';
                    ctx.fillText('âœ¦', x + 120, y + 10);
                }
                y += 35;
            }
        }

        function resetHexagram() {
            hexagramLines = [];
            changedLines = [];
            hexagramCount = 0;
            updateHexagramDisplay();
            document.getElementById('hexagram-progress').textContent = `Láº§n gieo: 0/6`;
            document.getElementById('moving-lines').textContent = '';
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('gieo-button').style.display = 'inline-block';
            document.getElementById('reset-button').style.display = 'none';
            document.getElementById('download-button').style.display = 'none';
            document.getElementById('changed-hexagram').style.display = 'none';
        }
    </script>
</body>
</html>